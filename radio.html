<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radio en Vivo üéß</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #111, #333);
      color: #fff;
      text-align: center;
      padding: 50px 20px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .radio-info {
      margin-bottom: 20px;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    audio {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      display: block;
      border-radius: 10px;
    }

    .listeners {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #bbb;
    }

    .limit {
      color: #f44336;
      font-weight: bold;
    }

    .now-playing {
      font-size: 1rem;
      margin-top: 10px;
    }

    footer {
      margin-top: 50px;
      font-size: 0.8rem;
      color: #888;
    }
  </style>
</head>
<body>
  <h1>üéôÔ∏è Radio Aurora FM</h1>
  <p class="radio-info">Transmisi√≥n en vivo - 24 horas de m√∫sica</p>

  <audio id="radioPlayer" controls autoplay>
    <source src="https://tuservidor.com/stream.mp3" type="audio/mpeg" />
    Tu navegador no soporta audio HTML5.
  </audio>

  <div class="now-playing" id="nowPlaying">Canci√≥n actual: Cargando...</div>
  <div class="listeners" id="listenersCount">Oyentes conectados: 0 / <span class="limit">5</span></div>

  <footer>¬© 2025 Radio Aurora FM | Todos los derechos reservados</footer>

  <!-- Script de Supabase -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Tus credenciales Supabase
    const SUPABASE_URL = 'https://lbatdowtivytktgltmig.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiYXRkb3d0aXZ5dGt0Z2x0bWlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNzY5NjksImV4cCI6MjA3Nzg1Mjk2OX0.8UZALMSFX-Vh5ErjeoyIQlSTLTEIZr0iHeRW4Glzots'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const MAX_LISTENERS = 5

    const listenersEl = document.getElementById('listenersCount')
    const nowPlayingEl = document.getElementById('nowPlaying')
    const audio = document.getElementById('radioPlayer')

    const sessionId = crypto.randomUUID?.() || (Date.now() + '-' + Math.random())

    // Registrar oyente
    async function registerListener() {
      const { count } = await supabase
        .from('listeners')
        .select('id', { count: 'exact', head: true })

      if (count >= MAX_LISTENERS) {
        listenersEl.innerHTML = `Oyentes conectados: ${count} / <span class="limit">${MAX_LISTENERS}</span> ‚Äî <strong>Capacidad completa</strong>`
        if (!audio.paused) audio.pause()
        return false
      }

      await supabase.from('listeners').insert({
        session_id: sessionId,
        user_agent: navigator.userAgent
      })

      return true
    }

    // Eliminar oyente al cerrar pesta√±a
    async function removeListener() {
      await supabase.from('listeners').delete().eq('session_id', sessionId)
    }

    // Actualizar datos desde la base
    async function refreshInfo() {
      const { count } = await supabase
        .from('listeners')
        .select('id', { count: 'exact', head: true })

      listenersEl.innerHTML = `Oyentes conectados: ${count} / <span class="limit">${MAX_LISTENERS}</span>`

      const { data: np } = await supabase
        .from('now_playing')
        .select('*')
        .order('started_at', { ascending: false })
        .limit(1)

      if (np && np.length > 0) {
        const track = np[0]
        nowPlayingEl.innerText =
          `Canci√≥n actual: ${track.title}${track.artist ? ' ‚Äî ' + track.artist : ''}${track.presenter ? ' (' + track.presenter + ')' : ''}`
      } else {
        nowPlayingEl.innerText = 'Canci√≥n actual: No disponible'
      }
    }

    // Realtime (actualizaci√≥n autom√°tica)
    const channel = supabase.channel('radio-realtime')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'listeners' }, payload => {
        refreshInfo()
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'now_playing' }, payload => {
        refreshInfo()
      })

    async function init() {
      const ok = await registerListener()
      await refreshInfo()
      await channel.subscribe()

      if (!ok) return
    }

    init()

    window.addEventListener('beforeunload', removeListener)
    window.addEventListener('unload', removeListener)
  </script>
</body>
</html>
