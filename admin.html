<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Panu</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .admin-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .logo-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin: 0 auto 20px auto;
        }

        .logo-container img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            background: white;
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50"><!-- Login Screen -->
  <div id="login-screen" class="login-container flex items-center justify-center p-4">
   <div class="login-card rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="logo-container"><img src="https://aurical.org/images/PanuLogo.jpg" alt="Panu Logo" onerror="this.style.display='none';">
     </div>
     <h1 class="text-3xl font-bold text-gray-800 mb-2">Panel de Administraci√≥n</h1>
     <p class="text-gray-600">Panu - Sublimaciones Premium</p>
     <p class="text-xs text-gray-500 mt-2">v1.029</p>
    </div>
    <form id="login-form" class="space-y-6">
     <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Usuario</label> <input type="text" id="username" name="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div>
     <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label> <input type="password" id="password" name="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div><button type="submit" id="login-btn" class="btn-primary w-full text-white py-3 rounded-lg font-medium flex items-center justify-center space-x-2"> <span>Iniciar Sesi√≥n</span>
      <div id="login-spinner" class="loading-spinner hidden"></div></button>
    </form>
    <div id="login-error" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm">
     Usuario o contrase√±a incorrectos
    </div>
   </div>
  </div><!-- Admin Dashboard -->
  <div id="admin-dashboard" class="hidden min-h-screen"><!-- Header -->
   <header class="gradient-bg text-white py-6 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
     <div class="flex items-center space-x-4"><img src="https://aurical.org/images/PanuLogo.jpg" alt="Panu Logo" class="header-logo" onerror="this.style.display='none';">
      <div>
       <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
       <p class="opacity-90">Gesti√≥n de productos - Panu</p>
       <p class="text-xs opacity-75 mt-1">Versi√≥n 1.026</p>
      </div>
     </div>
     <div class="flex items-center space-x-4"><span id="admin-user" class="text-sm opacity-90"></span> <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all"> Cerrar Sesi√≥n </button>
     </div>
    </div>
   </header><!-- Stats Cards -->
   <div class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
     <div class="stats-card text-white rounded-xl p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm opacity-90">Total Productos</p>
        <p id="total-products" class="text-3xl font-bold">0</p>
       </div>
       <div class="text-4xl opacity-80">
        üì¶
       </div>
      </div>
     </div>
     <div class="bg-green-500 text-white rounded-xl p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm opacity-90">Disponibles</p>
        <p id="available-products" class="text-3xl font-bold">0</p>
       </div>
       <div class="text-4xl opacity-80">
        ‚úÖ
       </div>
      </div>
     </div>
     <div class="bg-yellow-500 text-white rounded-xl p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm opacity-90">No Disponibles</p>
        <p id="unavailable-products" class="text-3xl font-bold">0</p>
       </div>
       <div class="text-4xl opacity-80">
        ‚è∏Ô∏è
       </div>
      </div>
     </div>
     <div class="bg-purple-500 text-white rounded-xl p-6">
      <div class="flex items-center justify-between">
       <div>
        <p class="text-sm opacity-90">Categor√≠as</p>
        <p id="total-categories" class="text-3xl font-bold">0</p>
       </div>
       <div class="text-4xl opacity-80">
        üè∑Ô∏è
       </div>
      </div>
     </div>
    </div><!-- Actions Bar -->
    <div class="flex justify-between items-center mb-6">
     <h2 class="text-2xl font-bold text-gray-800">Gesti√≥n de Productos</h2>
     <div class="flex space-x-4"><button onclick="refreshProducts()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center space-x-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
       </svg><span>Actualizar</span> </button> <button onclick="showAddProductModal()" class="btn-success text-white px-6 py-2 rounded-lg flex items-center space-x-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
       </svg><span>Nuevo Producto</span> </button>
     </div>
    </div><!-- Products Table -->
    <div class="admin-card rounded-xl shadow-lg overflow-hidden">
     <div class="table-container">
      <table class="w-full">
       <thead class="bg-gray-50 border-b">
        <tr>
         <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
         <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categor√≠a</th>
         <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
         <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
         <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
         <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
        </tr>
       </thead>
       <tbody id="products-table-body" class="bg-white divide-y divide-gray-200"><!-- Products will be loaded here -->
       </tbody>
      </table>
     </div>
     <div id="loading-products" class="flex justify-center items-center py-12">
      <div class="text-center">
       <div class="loading-spinner mx-auto mb-4"></div>
       <p class="text-gray-600">Cargando productos...</p>
      </div>
     </div>
     <div id="no-products" class="text-center py-12 hidden">
      <div class="text-6xl mb-4">
       üì¶
      </div>
      <h3 class="text-xl font-bold text-gray-700 mb-2">No hay productos</h3>
      <p class="text-gray-500">Comienza agregando tu primer producto</p>
     </div>
    </div>
   </div>
  </div><!-- Add/Edit Product Modal -->
  <div id="product-modal" class="modal fixed inset-0 z-50 hidden">
   <div class="flex items-center justify-center min-h-screen p-4">
    <div class="modal-content rounded-2xl shadow-2xl max-w-2xl w-full max-h-screen overflow-y-auto">
     <div class="p-8">
      <div class="flex justify-between items-center mb-6">
       <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Nuevo Producto</h2><button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
      </div>
      <form id="product-form" class="space-y-6"><input type="hidden" id="product-id" name="id">
       <div class="grid md:grid-cols-2 gap-6">
        <div><label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label> <input type="text" id="product-name" name="nombre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="product-category" class="block text-sm font-medium text-gray-700 mb-2">Categor√≠a</label> <select id="product-category" name="categoria" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Seleccionar categor√≠a</option> <option value="tazas">Tazas</option> <option value="remeras">Remeras</option> <option value="accesorios">Accesorios</option> <option value="otros">Otros</option> </select>
        </div>
       </div>
       <div><label for="product-description" class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label> <textarea id="product-description" name="descripcion" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
       </div>
       <div class="grid md:grid-cols-2 gap-6">
        <div><label for="product-price" class="block text-sm font-medium text-gray-700 mb-2">Precio (Gs.)</label> <input type="number" id="product-price" name="precio" required min="0" step="1000" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="product-available" class="block text-sm font-medium text-gray-700 mb-2">Estado</label> <select id="product-available" name="disponible" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="true">Disponible</option> <option value="false">No Disponible</option> </select>
        </div>
       </div>
       <div><label for="product-image" class="block text-sm font-medium text-gray-700 mb-2">Imagen Principal</label>
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors"><input type="file" id="product-image" name="imagen_principal" accept="image/*" class="hidden" onchange="handleMainImageUpload(this)">
         <div id="image-upload-area" class="cursor-pointer" onclick="document.getElementById('product-image').click()">
          <div class="text-4xl mb-2">
           üì∑
          </div>
          <p class="text-gray-600">Haz clic para seleccionar imagen</p>
          <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF hasta 10MB (se optimizar√° autom√°ticamente)</p>
         </div>
         <div id="image-preview" class="mt-4 hidden"><img id="preview-img" src="" alt="Vista previa" class="image-preview mx-auto"> <button type="button" onclick="removeMainImage()" class="mt-2 text-red-600 hover:text-red-800 text-sm"> ‚ùå Eliminar imagen </button>
         </div>
        </div>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Galer√≠a de Im√°genes (Opcional)</label>
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-400 transition-colors"><input type="file" id="gallery-images" multiple accept="image/*" class="hidden" onchange="handleGalleryImagesUpload(this)">
         <div class="cursor-pointer" onclick="document.getElementById('gallery-images').click()">
          <div class="text-3xl mb-2">
           üñºÔ∏è
          </div>
          <p class="text-gray-600">Agregar im√°genes a la galer√≠a</p>
          <p class="text-xs text-gray-500 mt-1">M√∫ltiples im√°genes para mostrar el producto</p>
         </div>
        </div>
        <div id="gallery-images-preview" class="mt-4 grid grid-cols-3 gap-4 hidden"><!-- Gallery images will be shown here -->
        </div>
       </div>
       <div class="flex justify-end space-x-4 pt-6 border-t"><button type="button" onclick="closeProductModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Cancelar </button> <button type="submit" id="save-product-btn" class="btn-primary text-white px-6 py-3 rounded-lg flex items-center space-x-2"> <span>Guardar Producto</span>
         <div id="save-spinner" class="loading-spinner hidden"></div></button>
       </div>
      </form>
     </div>
    </div>
   </div>
  </div><!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal fixed inset-0 z-50 hidden">
   <div class="flex items-center justify-center min-h-screen p-4">
    <div class="modal-content rounded-2xl shadow-2xl max-w-md w-full p-8">
     <div class="text-center">
      <div class="text-6xl mb-4">
       üóëÔ∏è
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">¬øEliminar Producto?</h3>
      <p class="text-gray-600 mb-6">Esta acci√≥n no se puede deshacer</p>
      <p id="delete-product-name" class="font-medium text-gray-800 mb-6"></p>
      <div class="flex space-x-4"><button onclick="closeDeleteModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Cancelar </button> <button onclick="confirmDelete()" id="confirm-delete-btn" class="btn-danger flex-1 text-white px-4 py-3 rounded-lg flex items-center justify-center space-x-2"> <span>Eliminar</span>
        <div id="delete-spinner" class="loading-spinner hidden"></div></button>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Notification Container -->
  <div id="notification-container"></div>
  <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://sxihojciyiypolxahoej.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4aWhvamNpeWl5cG9seGFob2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3Nzc3OTEsImV4cCI6MjA3NjM1Mzc5MX0.PGIGHwPmhTjpGCl-m61P2HXrSNwiR1ku8rgIshc-RUA';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let allProducts = [];
        let editingProduct = null;
        let productToDelete = null;
        let mainImageFile = null;
        let galleryImageFiles = [];
        let existingGalleryUrls = [];

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide and remove notification
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 300);
            }, 4000);
        }

        // Login function
        async function login(username, password) {
            try {
                console.log('Intentando login con:', { usuario: username, pass: password });
                
                // Primero verificar si existe la tabla login
                const { data: allUsers, error: listError } = await supabase
                    .from('login')
                    .select('*');
                
                console.log('Todos los usuarios en la tabla login:', allUsers);
                console.log('Error al listar usuarios:', listError);
                
                // Intentar login espec√≠fico
                const { data, error } = await supabase
                    .from('login')
                    .select('*')
                    .eq('usuario', username)
                    .eq('pass', password)
                    .single();

                console.log('Resultado del login:', { data, error });

                if (error) {
                    console.log('Error de Supabase:', error);
                    
                    // Verificar si el usuario existe (sin contrase√±a)
                    const { data: userCheck, error: userError } = await supabase
                        .from('login')
                        .select('*')
                        .eq('usuario', username)
                        .single();
                    
                    console.log('Verificaci√≥n de usuario:', { userCheck, userError });
                    
                    if (userError && userError.code === 'PGRST116') {
                        throw new Error('Usuario no encontrado');
                    } else if (userCheck && !data) {
                        throw new Error('Contrase√±a incorrecta');
                    } else {
                        throw new Error('Error de conexi√≥n: ' + error.message);
                    }
                }

                if (data) {
                    currentUser = data;
                    document.getElementById('admin-user').textContent = `Bienvenido, ${data.usuario}`;
                    
                    // Hide login screen and show dashboard
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    
                    // Load products
                    await loadProducts();
                    
                    showNotification('Sesi√≥n iniciada correctamente');
                    return true;
                }
                
                throw new Error('Usuario o contrase√±a incorrectos');
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Mostrar el error espec√≠fico en la interfaz
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                
                return false;
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('login-form').reset();
            document.getElementById('login-error').classList.add('hidden');
            showNotification('Sesi√≥n cerrada', 'warning');
        }

        // Load products from database
        async function loadProducts() {
            const loadingDiv = document.getElementById('loading-products');
            const tableBody = document.getElementById('products-table-body');
            const noProductsDiv = document.getElementById('no-products');
            
            try {
                loadingDiv.classList.remove('hidden');
                tableBody.innerHTML = '';
                noProductsDiv.classList.add('hidden');

                const { data, error } = await supabase
                    .from('producto')
                    .select('*')
                    .order('fecha_creacion', { ascending: false });

                if (error) throw error;

                allProducts = data || [];
                loadingDiv.classList.add('hidden');

                if (allProducts.length === 0) {
                    noProductsDiv.classList.remove('hidden');
                } else {
                    displayProducts(allProducts);
                }

                updateStats();
            } catch (error) {
                console.error('Error loading products:', error);
                loadingDiv.classList.add('hidden');
                showNotification('Error al cargar productos: ' + error.message, 'error');
            }
        }

        // Display products in table
        function displayProducts(products) {
            const tableBody = document.getElementById('products-table-body');
            
            tableBody.innerHTML = products.map(product => {
                // Handle gallery images display
                let galleryImages = [];
                if (product.imagen_galeria) {
                    try {
                        // Try parsing as JSON first (for backward compatibility)
                        if (typeof product.imagen_galeria === 'string' && product.imagen_galeria.startsWith('[')) {
                            galleryImages = JSON.parse(product.imagen_galeria);
                        } else if (Array.isArray(product.imagen_galeria)) {
                            // Already an array
                            galleryImages = product.imagen_galeria;
                        }
                    } catch (error) {
                        console.error('Error parsing gallery images:', error);
                        galleryImages = [];
                    }
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img src="${product.imagen_principal || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\' viewBox=\'0 0 80 80\'%3E%3Crect width=\'80\' height=\'80\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'40\' y=\'45\' text-anchor=\'middle\' font-size=\'12\' fill=\'%236b7280\'%3EImg%3C/text%3E%3C/svg%3E'}" 
                                     alt="${product.nombre}" class="product-image mr-4">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${product.nombre}</div>
                                    <div class="text-sm text-gray-500">${product.descripcion.substring(0, 50)}${product.descripcion.length > 50 ? '...' : ''}</div>
                                    ${galleryImages.length > 0 ? `<div class="text-xs text-blue-600 mt-1">üì∑ ${galleryImages.length} imagen(es) adicionales</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${product.categoria}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            Gs. ${product.precio.toLocaleString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${product.disponible ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${product.disponible ? 'Disponible' : 'No Disponible'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(product.fecha_creacion).toLocaleDateString('es-ES')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="editProduct(${product.id})" class="btn-warning text-white px-3 py-1 rounded text-xs">
                                    Editar
                                </button>
                                <button onclick="showDeleteModal(${product.id})" class="btn-danger text-white px-3 py-1 rounded text-xs">
                                    Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            const total = allProducts.length;
            const available = allProducts.filter(p => p.disponible).length;
            const unavailable = total - available;
            const categories = new Set(allProducts.map(p => p.categoria)).size;

            document.getElementById('total-products').textContent = total;
            document.getElementById('available-products').textContent = available;
            document.getElementById('unavailable-products').textContent = unavailable;
            document.getElementById('total-categories').textContent = categories;
        }

        // Show add product modal
        function showAddProductModal() {
            editingProduct = null;
            mainImageFile = null;
            galleryImageFiles = [];
            existingGalleryUrls = [];
            
            document.getElementById('modal-title').textContent = 'Nuevo Producto';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('image-upload-area').classList.remove('hidden');
            document.getElementById('gallery-images-preview').classList.add('hidden');
            document.getElementById('product-modal').classList.remove('hidden');
        }

        // Edit product
        function editProduct(productId) {
            editingProduct = allProducts.find(p => p.id === productId);
            if (!editingProduct) return;

            // Reset image states
            mainImageFile = null;
            galleryImageFiles = [];
            existingGalleryUrls = [];

            document.getElementById('modal-title').textContent = 'Editar Producto';
            document.getElementById('product-id').value = editingProduct.id;
            document.getElementById('product-name').value = editingProduct.nombre;
            document.getElementById('product-category').value = editingProduct.categoria;
            document.getElementById('product-description').value = editingProduct.descripcion;
            document.getElementById('product-price').value = editingProduct.precio;
            document.getElementById('product-available').value = editingProduct.disponible.toString();
            
            // Show existing main image if exists
            if (editingProduct.imagen_principal) {
                document.getElementById('preview-img').src = editingProduct.imagen_principal;
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('image-upload-area').classList.add('hidden');
            } else {
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('image-upload-area').classList.remove('hidden');
            }

            // Show existing gallery images if any
            if (editingProduct.imagen_galeria) {
                try {
                    let galleryUrls = [];
                    
                    // Handle both array and JSON string formats
                    if (Array.isArray(editingProduct.imagen_galeria)) {
                        galleryUrls = editingProduct.imagen_galeria;
                    } else if (typeof editingProduct.imagen_galeria === 'string') {
                        galleryUrls = JSON.parse(editingProduct.imagen_galeria);
                    }
                    
                    existingGalleryUrls = [...galleryUrls];
                    
                    if (galleryUrls.length > 0) {
                        const container = document.getElementById('gallery-images-preview');
                        container.classList.remove('hidden');
                        container.innerHTML = galleryUrls.map((imageUrl, index) => `
                            <div class="relative">
                                <img src="${imageUrl}" alt="Imagen galer√≠a ${index + 1}" 
                                     class="w-full h-24 object-cover rounded-lg">
                                <button type="button" onclick="removeExistingGalleryImage(${index})" 
                                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                                    √ó
                                </button>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error parsing gallery images:', error);
                    document.getElementById('gallery-images-preview').classList.add('hidden');
                }
            } else {
                document.getElementById('gallery-images-preview').classList.add('hidden');
            }

            document.getElementById('product-modal').classList.remove('hidden');
        }

        // Remove existing gallery image (for editing)
        function removeExistingGalleryImage(index) {
            existingGalleryUrls.splice(index, 1);
            displayExistingGalleryImages();
        }

        // Display existing gallery images
        function displayExistingGalleryImages() {
            const container = document.getElementById('gallery-images-preview');
            
            if (existingGalleryUrls.length === 0 && galleryImageFiles.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            
            // Show existing images
            const existingImagesHtml = existingGalleryUrls.map((imageUrl, index) => `
                <div class="relative">
                    <img src="${imageUrl}" alt="Imagen galer√≠a ${index + 1}" 
                         class="w-full h-24 object-cover rounded-lg">
                    <button type="button" onclick="removeExistingGalleryImage(${index})" 
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                        √ó
                    </button>
                </div>
            `).join('');

            // Show new images
            const newImagesHtml = galleryImageFiles.map((file, index) => {
                const reader = new FileReader();
                const imageId = `gallery-img-${index}`;
                
                reader.onload = function(e) {
                    const imgElement = document.getElementById(imageId);
                    if (imgElement) {
                        imgElement.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);

                return `
                    <div class="relative">
                        <img id="${imageId}" src="" alt="Nueva imagen ${index + 1}" 
                             class="w-full h-24 object-cover rounded-lg">
                        <button type="button" onclick="removeNewGalleryImage(${index})" 
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                            √ó
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML = existingImagesHtml + newImagesHtml;
        }

        // Close product modal
        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
            editingProduct = null;
            mainImageFile = null;
            galleryImageFiles = [];
            existingGalleryUrls = [];
        }

        // Show delete modal
        function showDeleteModal(productId) {
            productToDelete = allProducts.find(p => p.id === productId);
            if (!productToDelete) return;

            document.getElementById('delete-product-name').textContent = productToDelete.nombre;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            productToDelete = null;
        }

        // Confirm delete
        async function confirmDelete() {
            if (!productToDelete) return;

            const deleteBtn = document.getElementById('confirm-delete-btn');
            const deleteSpinner = document.getElementById('delete-spinner');
            
            try {
                deleteBtn.disabled = true;
                deleteSpinner.classList.remove('hidden');

                // Delete images from storage before deleting product
                if (productToDelete.imagen_principal) {
                    await deleteImageFromStorage(productToDelete.imagen_principal);
                }

                if (productToDelete.imagen_galeria) {
                    try {
                        let galleryUrls = [];
                        if (Array.isArray(productToDelete.imagen_galeria)) {
                            galleryUrls = productToDelete.imagen_galeria;
                        } else if (typeof productToDelete.imagen_galeria === 'string') {
                            galleryUrls = JSON.parse(productToDelete.imagen_galeria);
                        }
                        
                        for (const url of galleryUrls) {
                            await deleteImageFromStorage(url);
                        }
                    } catch (error) {
                        console.error('Error deleting gallery images:', error);
                    }
                }

                // Delete product from database
                const { error } = await supabase
                    .from('producto')
                    .delete()
                    .eq('id', productToDelete.id);

                if (error) throw error;

                showNotification('Producto eliminado correctamente');
                closeDeleteModal();
                await loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification('Error al eliminar producto: ' + error.message, 'error');
            } finally {
                deleteBtn.disabled = false;
                deleteSpinner.classList.add('hidden');
            }
        }

        // Refresh products
        async function refreshProducts() {
            await loadProducts();
            showNotification('Productos actualizados');
        }

        // Compress image function
        function compressImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Handle main image upload
        async function handleMainImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file size (10MB max before compression)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('La imagen es muy grande. M√°ximo 10MB permitido.', 'error');
                input.value = '';
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Por favor selecciona un archivo de imagen v√°lido.', 'error');
                input.value = '';
                return;
            }

            try {
                // Show compression message for large files
                if (file.size > 1024 * 1024) { // 1MB
                    showNotification('Optimizando imagen...', 'warning');
                }

                // Compress image
                const compressedFile = await compressImage(file);
                mainImageFile = new File([compressedFile], file.name, { type: 'image/jpeg' });
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('image-upload-area').classList.add('hidden');
                };
                reader.readAsDataURL(mainImageFile);

                // Show compression info
                const originalSize = (file.size / 1024 / 1024).toFixed(2);
                const compressedSize = (mainImageFile.size / 1024 / 1024).toFixed(2);
                if (file.size > mainImageFile.size) {
                    showNotification(`Imagen optimizada: ${originalSize}MB ‚Üí ${compressedSize}MB`);
                }
            } catch (error) {
                console.error('Error compressing image:', error);
                showNotification('Error al procesar la imagen', 'error');
                input.value = '';
            }
        }

        // Remove main image
        function removeMainImage() {
            mainImageFile = null;
            document.getElementById('product-image').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('image-upload-area').classList.remove('hidden');
        }

        // Handle gallery images upload
        async function handleGalleryImagesUpload(input) {
            const files = Array.from(input.files);
            
            if (files.length > 0) {
                showNotification('Procesando im√°genes de galer√≠a...', 'warning');
            }
            
            for (const file of files) {
                // Validate file size
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`${file.name} es muy grande. M√°ximo 10MB permitido.`, 'error');
                    continue;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification(`${file.name} no es un archivo de imagen v√°lido.`, 'error');
                    continue;
                }

                try {
                    // Compress gallery images (smaller size for gallery)
                    const compressedFile = await compressImage(file, 600, 0.7);
                    const compressedFileObj = new File([compressedFile], file.name, { type: 'image/jpeg' });
                    galleryImageFiles.push(compressedFileObj);
                } catch (error) {
                    console.error('Error compressing gallery image:', error);
                    showNotification(`Error procesando ${file.name}`, 'error');
                }
            }

            displayExistingGalleryImages();
            input.value = ''; // Reset input
            
            if (files.length > 0) {
                showNotification(`${files.length} imagen(es) agregada(s) a la galer√≠a`);
            }
        }

        // Remove new gallery image
        function removeNewGalleryImage(index) {
            galleryImageFiles.splice(index, 1);
            displayExistingGalleryImages();
        }

        // Convert image to base64 data URL (alternative to storage)
        async function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Upload image to Supabase Storage with fallback to base64
        async function uploadImageToStorage(file, folder = 'products') {
            try {
                // Generate unique filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = `${folder}/${fileName}`;

                // Show upload progress
                const originalSize = (file.size / 1024).toFixed(1);
                console.log(`Subiendo ${file.name} (${originalSize}KB) a ${filePath}`);

                // Try uploading to Supabase Storage first
                const { data, error } = await supabase.storage
                    .from('product')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.log('Storage upload failed, using base64 fallback:', error.message);
                    
                    // Fallback to base64 encoding
                    const base64Url = await convertImageToBase64(file);
                    console.log(`‚úÖ Imagen convertida a base64 (${originalSize}KB)`);
                    return base64Url;
                }

                // Get public URL if storage upload succeeded
                const { data: urlData } = supabase.storage
                    .from('product')
                    .getPublicUrl(filePath);

                console.log(`‚úÖ Imagen subida exitosamente: ${urlData.publicUrl}`);
                return urlData.publicUrl;
            } catch (error) {
                console.error('Error uploading image, trying base64 fallback:', error);
                
                // Final fallback to base64
                try {
                    const base64Url = await convertImageToBase64(file);
                    console.log(`‚úÖ Imagen convertida a base64 como respaldo`);
                    return base64Url;
                } catch (base64Error) {
                    console.error('Base64 conversion also failed:', base64Error);
                    throw new Error('No se pudo procesar la imagen');
                }
            }
        }

        // Delete image from storage (only for Supabase URLs, skip base64)
        async function deleteImageFromStorage(imageUrl) {
            try {
                // Skip deletion for base64 data URLs
                if (!imageUrl || imageUrl.startsWith('data:')) {
                    console.log('Skipping deletion of base64 image');
                    return;
                }
                
                // Only delete if it's a Supabase storage URL
                if (!imageUrl.includes('supabase')) {
                    console.log('Skipping deletion of non-Supabase URL');
                    return;
                }
                
                // Extract file path from URL
                const urlParts = imageUrl.split('/');
                const bucketIndex = urlParts.findIndex(part => part === 'product');
                if (bucketIndex === -1) return;
                
                const filePath = urlParts.slice(bucketIndex + 1).join('/');
                
                const { error } = await supabase.storage
                    .from('product')
                    .remove([filePath]);

                if (error) {
                    console.log('Could not delete image from storage:', error.message);
                } else {
                    console.log('‚úÖ Image deleted from storage:', filePath);
                }
            } catch (error) {
                console.error('Error deleting image from storage:', error);
            }
        }

        // Event Listeners
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('login-btn');
            const loginSpinner = document.getElementById('login-spinner');
            const loginError = document.getElementById('login-error');
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            loginBtn.disabled = true;
            loginSpinner.classList.remove('hidden');
            loginError.classList.add('hidden');
            
            const success = await login(username, password);
            
            if (!success) {
                loginError.classList.remove('hidden');
            }
            
            loginBtn.disabled = false;
            loginSpinner.classList.add('hidden');
        });

        document.getElementById('product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('save-product-btn');
            const saveSpinner = document.getElementById('save-spinner');
            
            try {
                saveBtn.disabled = true;
                saveSpinner.classList.remove('hidden');

                const formData = new FormData(this);
                const productData = {
                    nombre: formData.get('nombre'),
                    categoria: formData.get('categoria'),
                    descripcion: formData.get('descripcion'),
                    precio: parseInt(formData.get('precio')),
                    disponible: formData.get('disponible') === 'true'
                };

                // Handle main image
                if (mainImageFile) {
                    // Upload new main image to storage
                    productData.imagen_principal = await uploadImageToStorage(mainImageFile, 'products/main');
                    
                    // Delete old main image if editing
                    if (editingProduct && editingProduct.imagen_principal) {
                        await deleteImageFromStorage(editingProduct.imagen_principal);
                    }
                } else if (editingProduct && editingProduct.imagen_principal) {
                    // Keep existing image if no new image uploaded
                    productData.imagen_principal = editingProduct.imagen_principal;
                } else {
                    productData.imagen_principal = null;
                }

                // Handle gallery images - FIXED: Store as PostgreSQL array, not JSON string
                const allGalleryUrls = [...existingGalleryUrls]; // Keep existing URLs
                
                // Upload new gallery images
                for (const file of galleryImageFiles) {
                    try {
                        const imageUrl = await uploadImageToStorage(file, 'products/gallery');
                        allGalleryUrls.push(imageUrl);
                    } catch (error) {
                        console.error('Error uploading gallery image:', error);
                        showNotification(`Error subiendo imagen: ${file.name}`, 'warning');
                    }
                }
                
                // Store gallery URLs as PostgreSQL array (not JSON string)
                productData.imagen_galeria = allGalleryUrls.length > 0 ? allGalleryUrls : null;

                let result;
                if (editingProduct) {
                    // Delete removed gallery images from storage
                    if (editingProduct.imagen_galeria) {
                        try {
                            let oldGalleryUrls = [];
                            if (Array.isArray(editingProduct.imagen_galeria)) {
                                oldGalleryUrls = editingProduct.imagen_galeria;
                            } else if (typeof editingProduct.imagen_galeria === 'string') {
                                oldGalleryUrls = JSON.parse(editingProduct.imagen_galeria);
                            }
                            
                            const removedUrls = oldGalleryUrls.filter(url => !existingGalleryUrls.includes(url));
                            
                            for (const url of removedUrls) {
                                await deleteImageFromStorage(url);
                            }
                        } catch (error) {
                            console.error('Error deleting old gallery images:', error);
                        }
                    }
                    
                    // Update existing product
                    result = await supabase
                        .from('producto')
                        .update(productData)
                        .eq('id', editingProduct.id);
                } else {
                    // Create new product
                    productData.fecha_creacion = new Date().toISOString();
                    result = await supabase
                        .from('producto')
                        .insert([productData]);
                }

                if (result.error) throw result.error;

                showNotification(editingProduct ? 'Producto actualizado correctamente' : 'Producto creado correctamente');
                closeProductModal();
                await loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Error al guardar producto: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveSpinner.classList.add('hidden');
            }
        });

        // Close modals when clicking outside
        document.getElementById('product-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });

        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in (you could implement session storage here)
            console.log('Admin panel loaded - v1.026');
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99110ac1b298116c',t:'MTc2MDg4NDk0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>