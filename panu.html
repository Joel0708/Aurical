<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panu Sublimaciones - Productos √önicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'beige': '#F5E6D3',
                        'beige-dark': '#E8D5B7',
                        'brown': '#8B7355',
                        'brown-dark': '#6B5B47',
                        'cream': '#FFF8F0',
                        'cream-dark': '#F5F0E8',
                        'black': '#1C1C1C',
                        'black-light': '#2D2D2D',
                        'white': '#FFFFFF',
                        'accent': '#D4AF37'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .glass-effect {
            backdrop-filter: blur(15px);
            background: rgba(248, 248, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .glass-black {
            backdrop-filter: blur(15px);
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        
        .text-gradient {
            background: linear-gradient(45deg, #FFD700, #F5F5DC);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #FFD700, #000000);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #DAA520, #1a1a1a);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }
        
        .product-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(30, 58, 138, 0.2);
        }
        
        .hero-bg {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 30%, #FFD700 70%, #F5F5DC 100%);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }
        
        .status-caisy {
            background: #8B5CF6;
            color: white;
        }
        
        .status-offline {
            background: #EF4444;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #F8F8FF 0%, #FFFFFF 50%, #F5F5DC 100%);
            border: 2px solid #E6D7B8;
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
    </style>
</head>
<body class="bg-beige text-black font-sans">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-offline">
        üîÑ Conectando...
    </div>

    <!-- Header -->
    <header class="bg-cream bg-opacity-95 backdrop-blur-md border-b border-brown sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-accent to-brown rounded-lg flex items-center justify-center">
                        <span class="text-cream font-bold text-lg">P</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-black">Panu Sublimaciones</h1>
                        <p class="text-sm text-brown">Productos √∫nicos y personalizados</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="productCount" class="text-sm text-brown">0 productos</span>
                    <button onclick="openEditor()" class="bg-brown hover:bg-brown-dark text-cream px-4 py-2 rounded-lg transition-all font-medium">
                        üé® Editor
                    </button>
                    <a href="admin.html" class="bg-black hover:bg-black-light text-white px-4 py-2 rounded-lg transition-all font-medium">
                        üõ†Ô∏è Admin
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-cream via-beige to-brown-dark py-20">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <h2 class="text-5xl font-bold text-black mb-6">
                Sublimaci√≥n de <span class="text-accent">Alta Calidad</span>
            </h2>
            <p class="text-xl text-brown mb-8 max-w-2xl mx-auto">
                Transforma tus ideas en productos √∫nicos con nuestra tecnolog√≠a de sublimaci√≥n profesional
            </p>
            <button onclick="scrollToProducts()" class="bg-black hover:bg-black-light text-cream px-8 py-4 rounded-lg font-bold text-lg transition-all shadow-lg">
                üõçÔ∏è Ver Productos
            </button>
        </div>
    </section>

    <!-- Products Section -->
    <main class="max-w-7xl mx-auto px-6 py-16">
        <!-- Section Header -->
        <div class="text-center mb-12">
            <h3 class="text-4xl font-bold text-black mb-4">Nuestros Productos</h3>
            <p class="text-brown text-lg max-w-2xl mx-auto">
                Descubre nuestra colecci√≥n de productos personalizables con la mejor calidad de sublimaci√≥n
            </p>
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap justify-center gap-4 mb-12">
            <button onclick="filterProducts('all')" class="filter-btn active bg-brown text-cream border border-brown-dark px-6 py-3 rounded-lg font-medium transition-all hover:bg-brown-dark">
                Todos
            </button>
            <button onclick="filterProducts('Tazas')" class="filter-btn bg-cream border border-brown px-6 py-3 rounded-lg font-medium transition-all hover:bg-brown hover:text-cream text-black">
                Tazas
            </button>
            <button onclick="filterProducts('Camisetas')" class="filter-btn bg-cream border border-brown px-6 py-3 rounded-lg font-medium transition-all hover:bg-brown hover:text-cream text-black">
                Camisetas
            </button>
            <button onclick="filterProducts('Accesorios')" class="filter-btn bg-cream border border-brown px-6 py-3 rounded-lg font-medium transition-all hover:bg-brown hover:text-cream text-black">
                Accesorios
            </button>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            <!-- Loading State -->
            <div class="col-span-full text-center py-16">
                <div class="text-6xl mb-4">üîÑ</div>
                <h3 class="text-2xl font-bold text-gold mb-2">Cargando productos...</h3>
                <p class="text-beige">Conectando con Caisy CMS...</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-black border-t border-brown mt-20 py-12">
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h4 class="text-xl font-bold text-cream mb-4">Panu Sublimaciones</h4>
                    <p class="text-beige">
                        Especialistas en sublimaci√≥n de alta calidad. Transformamos tus ideas en productos √∫nicos.
                    </p>
                </div>
                <div>
                    <h4 class="text-xl font-bold text-cream mb-4">Contacto</h4>
                    <div class="space-y-2 text-beige">
                        <p>üìß panu@aurical.org</p>
                        <p>üì± +1 234 567 8900</p>
                        <p>üìç Tu Ciudad, Pa√≠s</p>
                    </div>
                </div>
                <div>
                    <h4 class="text-xl font-bold text-cream mb-4">S√≠guenos</h4>
                    <div class="flex space-x-4">
                        <a href="#" class="bg-brown p-3 rounded-lg hover:bg-brown-dark transition-all">üìò</a>
                        <a href="#" class="bg-brown p-3 rounded-lg hover:bg-brown-dark transition-all">üì∑</a>
                        <a href="#" class="bg-brown p-3 rounded-lg hover:bg-brown-dark transition-all">üê¶</a>
                    </div>
                </div>
            </div>
            <div class="border-t border-brown mt-8 pt-8 text-center">
                <p class="text-beige">
                    ¬© 2024 Panu Sublimaciones. Todos los derechos reservados. 
                    <span class="text-accent">Desarrollado por Esteban Paez Building</span>
                </p>
            </div>
        </div>
    </footer>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl text-black hover:text-beige-dark transition-colors">
                √ó
            </button>
            
            <div id="modalContent">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="editorModal" class="modal">
        <div class="modal-content glass-navy" style="max-width: 1200px; max-height: 95%;">
            <button onclick="closeEditor()" class="absolute top-4 right-4 text-2xl text-beige hover:text-white transition-colors z-10">
                √ó
            </button>
            
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gradient mb-2">üé® Editor de Sublimaci√≥n</h3>
                <p class="text-navy-light">Dise√±a tu producto personalizado</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                <!-- Canvas Area -->
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-lg p-4 h-full">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-beige font-bold">√Årea de Dise√±o</h4>
                            <div class="flex gap-2">
                                <button onclick="clearCanvas()" class="glass-effect px-3 py-1 rounded text-sm hover:bg-beige hover:bg-opacity-20 transition-all">
                                    üóëÔ∏è Limpiar
                                </button>
                                <button onclick="downloadDesign()" class="btn-primary text-navy px-3 py-1 rounded text-sm">
                                    üíæ Descargar
                                </button>
                            </div>
                        </div>
                        <div class="relative bg-white rounded-lg" style="height: 400px;">
                            <canvas id="designCanvas" width="600" height="400" class="w-full h-full border-2 border-beige border-opacity-30 rounded-lg cursor-crosshair"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Tools Panel -->
                <div class="space-y-4">
                    <!-- Product Selection -->
                    <div class="glass-effect rounded-lg p-4">
                        <h4 class="text-beige font-bold mb-3">Producto Base</h4>
                        <select id="productSelect" class="w-full bg-navy text-beige p-2 rounded border border-beige border-opacity-30">
                            <option value="taza">Taza Blanca</option>
                            <option value="camiseta">Camiseta</option>
                            <option value="mouse-pad">Mouse Pad</option>
                        </select>
                    </div>
                    
                    <!-- Drawing Tools -->
                    <div class="glass-effect rounded-lg p-4">
                        <h4 class="text-beige font-bold mb-3">Herramientas</h4>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button onclick="setTool('brush')" class="tool-btn active glass-effect p-2 rounded text-sm hover:bg-beige hover:bg-opacity-20 transition-all">
                                üñåÔ∏è Pincel
                            </button>
                            <button onclick="setTool('eraser')" class="tool-btn glass-effect p-2 rounded text-sm hover:bg-beige hover:bg-opacity-20 transition-all">
                                üßΩ Borrador
                            </button>
                            <button onclick="setTool('text')" class="tool-btn glass-effect p-2 rounded text-sm hover:bg-beige hover:bg-opacity-20 transition-all">
                                üìù Texto
                            </button>
                            <button onclick="setTool('shape')" class="tool-btn glass-effect p-2 rounded text-sm hover:bg-beige hover:bg-opacity-20 transition-all">
                                üî∑ Formas
                            </button>
                        </div>
                        
                        <!-- Color Picker -->
                        <div class="mb-3">
                            <label class="block text-beige text-sm mb-1">Color:</label>
                            <input type="color" id="colorPicker" value="#000000" class="w-full h-8 rounded border border-beige border-opacity-30">
                        </div>
                        
                        <!-- Brush Size -->
                        <div class="mb-3">
                            <label class="block text-beige text-sm mb-1">Tama√±o: <span id="brushSizeValue">5</span>px</label>
                            <input type="range" id="brushSize" min="1" max="50" value="5" class="w-full">
                        </div>
                    </div>
                    
                    <!-- Text Tools -->
                    <div id="textTools" class="glass-effect rounded-lg p-4 hidden">
                        <h4 class="text-beige font-bold mb-3">Opciones de Texto</h4>
                        <input type="text" id="textInput" placeholder="Escribe tu texto..." class="w-full bg-navy text-beige p-2 rounded border border-beige border-opacity-30 mb-2">
                        <select id="fontSelect" class="w-full bg-navy text-beige p-2 rounded border border-beige border-opacity-30 mb-2">
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Georgia">Georgia</option>
                        </select>
                        <input type="range" id="fontSize" min="12" max="72" value="24" class="w-full">
                        <label class="block text-beige text-sm">Tama√±o: <span id="fontSizeValue">24</span>px</label>
                    </div>
                    
                    <!-- Image Upload -->
                    <div class="glass-effect rounded-lg p-4">
                        <h4 class="text-beige font-bold mb-3">Subir Imagen</h4>
                        <input type="file" id="imageUpload" accept="image/*" class="w-full bg-navy text-beige p-2 rounded border border-beige border-opacity-30 text-sm">
                    </div>
                    
                    <!-- Actions -->
                    <div class="glass-effect rounded-lg p-4">
                        <h4 class="text-beige font-bold mb-3">Acciones</h4>
                        <div class="space-y-2">
                            <button onclick="saveDesign()" class="w-full btn-primary text-navy py-2 rounded font-medium">
                                üíæ Guardar Dise√±o
                            </button>
                            <button onclick="requestQuote()" class="w-full glass-effect py-2 rounded font-medium hover:bg-beige hover:bg-opacity-20 transition-all">
                                üí∞ Solicitar Cotizaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allProducts = [];
        let filteredProducts = [];
        let currentFilter = 'all';
        let caisyConnected = false;

        // Helper function to extract text from Caisy rich text field (same as admin.html)
        function extractTextFromDescription(descripcion) {
            if (!descripcion) return '';
            
            // If it's already a string, return it
            if (typeof descripcion === 'string') return descripcion;
            
            // If it has json field, try to extract text from it
            if (descripcion.json) {
                try {
                    const jsonData = typeof descripcion.json === 'string' ? 
                        JSON.parse(descripcion.json) : descripcion.json;
                    
                    // Extract text from Caisy's rich text JSON structure
                    function extractTextFromNodes(nodes) {
                        if (!nodes || !Array.isArray(nodes)) return '';
                        
                        return nodes.map(node => {
                            if (node.type === 'text') return node.text || '';
                            if (node.children) return extractTextFromNodes(node.children);
                            return '';
                        }).join(' ').trim();
                    }
                    
                    if (jsonData.children) {
                        return extractTextFromNodes(jsonData.children);
                    }
                    
                    // Fallback: convert JSON to string
                    return JSON.stringify(jsonData).replace(/[{}"\[\]]/g, ' ').trim();
                } catch (error) {
                    console.log('Error parsing description JSON:', error);
                    return String(descripcion.json);
                }
            }
            
            // Fallback to string conversion
            return String(descripcion);
        }

        // Caisy configuration (same as admin.html)
        const CAISY_CONFIG = {
            endpoint: 'https://cloud.caisy.io/api/v3/e/d5020874-9338-4ce1-9f01-872741713f01/graphql',
            apiKey: 'DR4cQSjCXwdqZDs20vuKsPmGreNnSu4T'
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Initialize page
        async function initializePage() {
            console.log('üöÄ Iniciando aplicaci√≥n Panu Sublimaciones...');
            updateConnectionStatus('connecting');
            
            // Test connection first
            const connected = await checkCaisyConnection();
            console.log('üîó Estado de conexi√≥n:', connected ? 'CONECTADO' : 'DESCONECTADO');
            
            // Load products
            await loadProducts();
            
            console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
        }

        // Check Caisy connection
        async function checkCaisyConnection() {
            try {
                console.log('üîç Verificando conexi√≥n a Caisy...');
                console.log('üîó Endpoint:', CAISY_CONFIG.endpoint);
                console.log('üîë API Key presente:', !!CAISY_CONFIG.apiKey);
                
                const testQuery = `query { __typename }`;
                const response = await fetch(CAISY_CONFIG.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-caisy-apikey': CAISY_CONFIG.apiKey
                    },
                    body: JSON.stringify({ query: testQuery })
                });

                console.log('üì° Respuesta HTTP:', response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üì• Datos de respuesta:', data);
                    
                    if (data && !data.errors) {
                        caisyConnected = true;
                        updateConnectionStatus('caisy');
                        console.log('‚úÖ Conectado exitosamente a Caisy CMS');
                        return true;
                    } else {
                        console.log('‚ö†Ô∏è Respuesta con errores:', data.errors);
                        throw new Error('Response contains errors');
                    }
                } else {
                    const errorText = await response.text();
                    console.log('‚ùå Error HTTP:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n:', error);
                caisyConnected = false;
                updateConnectionStatus('offline');
                console.log('‚ùå Sin conexi√≥n a Caisy, modo offline');
                return false;
            }
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            
            switch (status) {
                case 'connecting':
                    statusEl.className = 'connection-status status-offline';
                    statusEl.textContent = 'üîÑ Conectando...';
                    break;
                case 'caisy':
                    statusEl.className = 'connection-status status-caisy';
                    statusEl.textContent = '‚òÅÔ∏è Conectado a Caisy';
                    break;
                case 'offline':
                    statusEl.className = 'connection-status status-offline';
                    statusEl.textContent = 'üì± Modo Local';
                    break;
            }
        }

        // Load products from Caisy and localStorage
        async function loadProducts() {
            try {
                // Always try to load from Caisy first if connected
                if (caisyConnected) {
                    console.log('üîÑ Intentando cargar productos desde Caisy...');
                    await loadFromCaisy();
                } else {
                    console.log('üì± Caisy no conectado, cargando desde localStorage...');
                    // Fallback to localStorage
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                console.log('üîÑ Fallback a localStorage por error...');
                loadFromLocalStorage();
            }
        }

        // Load products from Caisy with comprehensive debugging
        async function loadFromCaisy() {
            try {
                console.log('üîç Iniciando conexi√≥n con Caisy CMS...');
                console.log('üîó Endpoint:', CAISY_CONFIG.endpoint);
                console.log('üîë API Key configurada:', CAISY_CONFIG.apiKey ? 'S√≠' : 'No');
                
                // Step 1: Test basic connection
                console.log('\n--- PASO 1: Verificando conexi√≥n b√°sica ---');
                const basicQuery = `query { __typename }`;
                const basicResponse = await fetch(CAISY_CONFIG.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-caisy-apikey': CAISY_CONFIG.apiKey
                    },
                    body: JSON.stringify({ query: basicQuery })
                });

                console.log('üì° Status de respuesta:', basicResponse.status);
                console.log('üì° Headers de respuesta:', Object.fromEntries(basicResponse.headers.entries()));

                if (!basicResponse.ok) {
                    throw new Error(`HTTP ${basicResponse.status}: ${basicResponse.statusText}`);
                }

                const basicData = await basicResponse.json();
                console.log('‚úÖ Conexi√≥n b√°sica exitosa:', basicData);

                // Step 2: Get schema information
                console.log('\n--- PASO 2: Obteniendo esquema de Caisy ---');
                const schemaQuery = `
                    query {
                        __schema {
                            queryType {
                                fields {
                                    name
                                    description
                                    type {
                                        name
                                        kind
                                        ofType {
                                            name
                                        }
                                    }
                                }
                            }
                        }
                    }
                `;

                const schemaResponse = await fetch(CAISY_CONFIG.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-caisy-apikey': CAISY_CONFIG.apiKey
                    },
                    body: JSON.stringify({ query: schemaQuery })
                });

                const schemaData = await schemaResponse.json();
                const availableFields = schemaData.data?.__schema?.queryType?.fields || [];
                
                console.log('üìã Campos disponibles en el esquema:');
                availableFields.forEach(field => {
                    console.log(`  - ${field.name} (${field.type?.name || field.type?.kind})`);
                });

                // Step 3: Find product-related queries
                console.log('\n--- PASO 3: Buscando consultas de productos ---');
                const productQueries = availableFields.filter(field => 
                    field.name.toLowerCase().includes('product') || 
                    field.name.toLowerCase().includes('producto')
                );

                console.log('üîç Consultas relacionadas con productos encontradas:');
                productQueries.forEach(query => {
                    console.log(`  - ${query.name}: ${query.description || 'Sin descripci√≥n'}`);
                });

                if (productQueries.length === 0) {
                    console.log('‚ùå No se encontraron consultas de productos en el esquema');
                    console.log('üìù Campos disponibles que podr√≠an ser √∫tiles:');
                    availableFields.slice(0, 10).forEach(field => {
                        console.log(`  - ${field.name}`);
                    });
                    throw new Error('No se encontraron consultas de productos en Caisy');
                }

                // Step 4: Try each product query
                console.log('\n--- PASO 4: Probando consultas de productos ---');
                let productos = [];
                let successfulQuery = null;

                for (const queryField of productQueries) {
                    try {
                        console.log(`\nüîç Probando consulta: ${queryField.name}`);
                        
                        // Try a simple query first to see the structure
                        const simpleQuery = `
                            query {
                                ${queryField.name} {
                                    __typename
                                }
                            }
                        `;

                        console.log('üì§ Enviando consulta simple:', simpleQuery);
                        const simpleResponse = await fetch(CAISY_CONFIG.endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-caisy-apikey': CAISY_CONFIG.apiKey
                            },
                            body: JSON.stringify({ query: simpleQuery })
                        });

                        const simpleData = await simpleResponse.json();
                        console.log('üì• Respuesta simple:', simpleData);

                        if (simpleData.errors) {
                            console.log(`‚ùå Error en consulta simple: ${simpleData.errors[0]?.message}`);
                            continue;
                        }

                        if (!simpleData.data || !simpleData.data[queryField.name]) {
                            console.log(`‚ö†Ô∏è ${queryField.name} no devolvi√≥ datos`);
                            continue;
                        }

                        // Now try the full query
                        console.log('‚úÖ Consulta simple exitosa, probando consulta completa...');
                        
                        const fullQuery = `
                            query {
                                ${queryField.name} {
                                    id
                                    nombre
                                    name
                                    title
                                    descripcion {
                                        json
                                    }
                                    description {
                                        json
                                    }
                                    precio
                                    price
                                    categoria
                                    category
                                    imagen_principal {
                                        src
                                        url
                                    }
                                    image {
                                        src
                                        url
                                    }
                                    imagenes_galeria {
                                        ... on Asset {
                                            src
                                            url
                                        }
                                    }
                                    images {
                                        ... on Asset {
                                            src
                                            url
                                        }
                                    }
                                    disponible
                                    available
                                    fecha_creacion
                                    createdAt
                                    _meta {
                                        createdAt
                                        updatedAt
                                    }
                                }
                            }
                        `;

                        console.log('üì§ Enviando consulta completa...');
                        const fullResponse = await fetch(CAISY_CONFIG.endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-caisy-apikey': CAISY_CONFIG.apiKey
                            },
                            body: JSON.stringify({ query: fullQuery })
                        });

                        const fullData = await fullResponse.json();
                        console.log('üì• Respuesta completa:', fullData);

                        if (fullData.errors) {
                            console.log(`‚ùå Error en consulta completa: ${fullData.errors[0]?.message}`);
                            
                            // Try a more basic query
                            const basicProductQuery = `
                                query {
                                    ${queryField.name} {
                                        id
                                        nombre
                                        name
                                        title
                                    }
                                }
                            `;
                            
                            console.log('üîÑ Probando consulta b√°sica...');
                            const basicProductResponse = await fetch(CAISY_CONFIG.endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'x-caisy-apikey': CAISY_CONFIG.apiKey
                                },
                                body: JSON.stringify({ query: basicProductQuery })
                            });

                            const basicProductData = await basicProductResponse.json();
                            console.log('üì• Respuesta b√°sica:', basicProductData);
                            
                            if (!basicProductData.errors && basicProductData.data?.[queryField.name]) {
                                productos = Array.isArray(basicProductData.data[queryField.name]) ? 
                                    basicProductData.data[queryField.name] : [basicProductData.data[queryField.name]];
                                successfulQuery = queryField.name;
                                console.log(`‚úÖ Consulta b√°sica exitosa con ${productos.length} productos`);
                                break;
                            }
                            continue;
                        }

                        if (fullData.data && fullData.data[queryField.name]) {
                            productos = Array.isArray(fullData.data[queryField.name]) ? 
                                fullData.data[queryField.name] : [fullData.data[queryField.name]];
                            successfulQuery = queryField.name;
                            console.log(`‚úÖ Consulta completa exitosa con ${productos.length} productos`);
                            break;
                        }

                    } catch (queryError) {
                        console.log(`‚ùå Error ejecutando ${queryField.name}:`, queryError.message);
                    }
                }

                // Step 5: Process results
                console.log('\n--- PASO 5: Procesando resultados ---');
                
                if (!successfulQuery || productos.length === 0) {
                    console.log('‚ùå No se pudieron obtener productos desde Caisy');
                    console.log('üìã Consultas disponibles encontradas:', productQueries.map(q => q.name));
                    console.log('üîç Intentando consultas alternativas...');
                    
                    // Try alternative queries
                    const alternativeQueries = ['allProduct', 'products', 'allProducts', 'Product', 'Producto'];
                    
                    for (const queryName of alternativeQueries) {
                        try {
                            console.log(`üîç Probando consulta alternativa: ${queryName}`);
                            const altQuery = `
                                query {
                                    ${queryName} {
                                        id
                                        nombre
                                        name
                                        title
                                    }
                                }
                            `;
                            
                            const altResponse = await fetch(CAISY_CONFIG.endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'x-caisy-apikey': CAISY_CONFIG.apiKey
                                },
                                body: JSON.stringify({ query: altQuery })
                            });

                            const altData = await altResponse.json();
                            console.log(`üì• Respuesta de ${queryName}:`, altData);
                            
                            if (!altData.errors && altData.data?.[queryName]) {
                                productos = Array.isArray(altData.data[queryName]) ? 
                                    altData.data[queryName] : [altData.data[queryName]];
                                successfulQuery = queryName;
                                console.log(`‚úÖ ¬°Productos encontrados con ${queryName}!`, productos.length);
                                break;
                            }
                        } catch (altError) {
                            console.log(`‚ùå Error con ${queryName}:`, altError.message);
                        }
                    }
                    
                    if (!successfulQuery || productos.length === 0) {
                        console.log('‚ùå Todas las consultas fallaron');
                        console.log('üîÑ Creando productos de demostraci√≥n...');
                        updateConnectionStatus('offline');
                        showNotification('‚ùå No se encontraron productos en Caisy. Verifica que tengas productos creados en tu CMS.', 'warning');
                        createDemoProducts();
                        return;
                    }
                }

                console.log(`‚úÖ Productos obtenidos exitosamente desde: ${successfulQuery}`);
                console.log('üì¶ Productos raw:', productos);

                // Transform products
                const caisyProducts = productos.map((producto, index) => {
                    console.log(`üîÑ Transformando producto ${index + 1}:`, producto);
                    
                    // Extract name (try different fields)
                    const name = producto.nombre || producto.name || producto.title || `Producto ${index + 1}`;
                    
                    // Extract price (try different fields)
                    const price = parseFloat(producto.precio || producto.price || 0);
                    
                    // Extract description
                    const descripcion = producto.descripcion || producto.description;
                    const description = extractTextFromDescription(descripcion) || 'Producto de sublimaci√≥n personalizable';
                    
                    // Extract category
                    const category = producto.categoria || producto.category || 'Otros';
                    
                    // Extract images
                    const images = [];
                    if (producto.imagen_principal?.src) images.push(producto.imagen_principal.src);
                    if (producto.imagen_principal?.url) images.push(producto.imagen_principal.url);
                    if (producto.image?.src) images.push(producto.image.src);
                    if (producto.image?.url) images.push(producto.image.url);
                    
                    if (producto.imagenes_galeria) {
                        producto.imagenes_galeria.forEach(img => {
                            if (img.src) images.push(img.src);
                            if (img.url) images.push(img.url);
                        });
                    }
                    
                    if (producto.images) {
                        producto.images.forEach(img => {
                            if (img.src) images.push(img.src);
                            if (img.url) images.push(img.url);
                        });
                    }
                    
                    // Extract availability
                    const available = producto.disponible !== false && producto.available !== false;
                    
                    // Extract creation date
                    const createdAt = producto.fecha_creacion || producto.createdAt || producto._meta?.createdAt || new Date().toISOString();
                    
                    const transformedProduct = {
                        id: producto.id || `caisy_${index}`,
                        name: name,
                        price: price,
                        description: description,
                        category: category,
                        stock: available ? 10 : 0,
                        images: [...new Set(images)], // Remove duplicates
                        available: available,
                        createdAt: createdAt,
                        source: 'caisy',
                        rawData: producto // Keep original for debugging
                    };
                    
                    console.log(`‚úÖ Producto transformado:`, transformedProduct);
                    return transformedProduct;
                });

                console.log('\n--- RESULTADO FINAL ---');
                console.log(`‚úÖ ${caisyProducts.length} productos procesados exitosamente`);
                
                // Save to localStorage
                localStorage.setItem('panuProducts', JSON.stringify(caisyProducts));
                localStorage.setItem('panuProductsLastSync', new Date().toISOString());
                localStorage.setItem('panuProductsSource', 'caisy');
                localStorage.setItem('panuProductsQuery', successfulQuery);

                allProducts = caisyProducts;
                
                showNotification(`‚úÖ ${caisyProducts.length} productos sincronizados desde Caisy`, 'success');
                applyFilter();

            } catch (error) {
                console.error('\n‚ùå ERROR COMPLETO:', error);
                console.error('Stack trace:', error.stack);
                
                updateConnectionStatus('offline');
                showNotification(`‚ùå Error conectando con Caisy: ${error.message}`, 'error');
                
                // Fallback to demo products
                createDemoProducts();
            }
        }

        // Create demo products when Caisy is not available
        function createDemoProducts() {
            const demoProducts = [
                {
                    id: 'demo_1',
                    name: 'Taza Personalizada Premium',
                    price: 15.99,
                    description: 'Taza de cer√°mica blanca de alta calidad, perfecta para sublimaci√≥n. Resistente al microondas y lavavajillas.',
                    category: 'Tazas',
                    stock: 25,
                    images: [],
                    available: true,
                    createdAt: new Date().toISOString(),
                    source: 'demo'
                },
                {
                    id: 'demo_2',
                    name: 'Camiseta Algod√≥n 100%',
                    price: 22.50,
                    description: 'Camiseta de algod√≥n 100% en color blanco, ideal para dise√±os personalizados con sublimaci√≥n.',
                    category: 'Camisetas',
                    stock: 15,
                    images: [],
                    available: true,
                    createdAt: new Date().toISOString(),
                    source: 'demo'
                },
                {
                    id: 'demo_3',
                    name: 'Mouse Pad Ergon√≥mico',
                    price: 12.99,
                    description: 'Mouse pad con base antideslizante y superficie lisa perfecta para impresi√≥n por sublimaci√≥n.',
                    category: 'Accesorios',
                    stock: 30,
                    images: [],
                    available: true,
                    createdAt: new Date().toISOString(),
                    source: 'demo'
                },
                {
                    id: 'demo_4',
                    name: 'Taza M√°gica T√©rmica',
                    price: 24.99,
                    description: 'Taza que cambia de color con el calor. Perfecta para dise√±os sorpresa y regalos √∫nicos.',
                    category: 'Tazas',
                    stock: 8,
                    images: [],
                    available: true,
                    createdAt: new Date().toISOString(),
                    source: 'demo'
                },
                {
                    id: 'demo_5',
                    name: 'Camiseta Deportiva Dri-Fit',
                    price: 28.99,
                    description: 'Camiseta deportiva con tecnolog√≠a que absorbe la humedad, ideal para dise√±os deportivos.',
                    category: 'Camisetas',
                    stock: 12,
                    images: [],
                    available: true,
                    createdAt: new Date().toISOString(),
                    source: 'demo'
                },
                {
                    id: 'demo_6',
                    name: 'Llavero Acr√≠lico Personalizable',
                    price: 8.99,
                    description: 'Llavero de acr√≠lico transparente con forma rectangular, perfecto para fotos y dise√±os peque√±os.',
                    category: 'Accesorios',
                    stock: 50,
                    images: [],
                    available: true,
                    createdAt: new Date().toISOString(),
                    source: 'demo'
                }
            ];

            // Save demo products to localStorage
            localStorage.setItem('panuProducts', JSON.stringify(demoProducts));
            localStorage.setItem('panuProductsLastSync', new Date().toISOString());
            localStorage.setItem('panuProductsSource', 'demo');

            allProducts = demoProducts;
            console.log('‚úÖ Productos de demostraci√≥n creados:', allProducts.length);
            showNotification('üì¶ Productos de demostraci√≥n cargados', 'info');
            applyFilter();
        }

        // Load products from localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('panuProducts');
                if (saved) {
                    allProducts = JSON.parse(saved);
                    console.log('üì¶ Productos cargados desde localStorage:', allProducts.length);
                    
                    // Check if we have products
                    if (allProducts.length > 0) {
                        const lastSync = localStorage.getItem('panuProductsLastSync');
                        const source = localStorage.getItem('panuProductsSource') || 'unknown';
                        
                        console.log('üìÖ √öltima sincronizaci√≥n:', lastSync);
                        console.log('üìç Fuente de datos:', source);
                        
                        showNotification(`üì¶ ${allProducts.length} productos cargados (${source})`, 'info');
                        applyFilter();
                        return;
                    }
                }
                
                // If no products found, create demo products
                console.log('üì¶ No hay productos guardados, creando productos de demostraci√≥n');
                createDemoProducts();
                
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                console.log('üì¶ Error en localStorage, creando productos de demostraci√≥n');
                createDemoProducts();
            }
        }

        // Filter products
        function filterProducts(category) {
            currentFilter = category;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-brown', 'text-cream');
                btn.classList.add('bg-cream', 'text-black', 'hover:bg-brown', 'hover:text-cream');
            });
            
            event.target.classList.remove('bg-cream', 'text-black', 'hover:bg-brown', 'hover:text-cream');
            event.target.classList.add('active', 'bg-brown', 'text-cream');
            
            applyFilter();
        }

        // Apply current filter
        function applyFilter() {
            if (currentFilter === 'all') {
                filteredProducts = allProducts;
            } else {
                filteredProducts = allProducts.filter(product => product.category === currentFilter);
            }
            
            renderProducts();
        }

        // Render products
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const productCount = document.getElementById('productCount');
            
            productCount.textContent = `${filteredProducts.length} productos`;
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <div class="text-6xl mb-4">üì¶</div>
                        <h3 class="text-2xl font-bold text-beige mb-2">No hay productos disponibles</h3>
                        <p class="text-navy-light">
                            ${currentFilter === 'all' ? 'A√∫n no hay productos en el cat√°logo' : `No hay productos en la categor√≠a "${currentFilter}"`}
                        </p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card bg-cream border border-brown rounded-xl overflow-hidden cursor-pointer shadow-lg hover:shadow-xl transition-all" onclick="openProductModal('${product.id}')">
                    <div class="relative">
                        ${product.images && product.images.length > 0 ? `
                            <img src="${product.images[0]}" alt="${product.name}" class="w-full h-48 object-cover">
                        ` : `
                            <div class="w-full h-48 bg-gradient-to-br from-beige to-brown flex items-center justify-center">
                                <div class="text-4xl text-cream">üíé</div>
                            </div>
                        `}
                        <div class="absolute top-2 right-2 flex gap-2">
                            <span class="bg-brown text-cream px-2 py-1 rounded text-xs font-bold">
                                ${product.category}
                            </span>
                            ${product.source === 'caisy' ? `
                                <span class="bg-accent text-black px-2 py-1 rounded text-xs font-bold">
                                    ‚òÅÔ∏è Caisy
                                </span>
                            ` : ''}
                        </div>
                        ${product.stock <= 5 ? `
                            <div class="absolute top-2 left-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
                                ${product.stock <= 0 ? 'Agotado' : `√öltimas ${product.stock}`}
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-black mb-2">${product.name}</h3>
                        <p class="text-brown text-sm mb-3 line-clamp-2">${product.description || 'Producto de sublimaci√≥n personalizable'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-black">$${product.price.toFixed(2)}</span>
                            <button class="bg-black hover:bg-black-light text-cream px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                Ver Detalles
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Open product modal
        function openProductModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const modal = document.getElementById('productModal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        ${product.images && product.images.length > 0 ? `
                            <img src="${product.images[0]}" alt="${product.name}" class="w-full rounded-lg">
                            ${product.images.length > 1 ? `
                                <div class="flex gap-2 mt-4 overflow-x-auto">
                                    ${product.images.slice(1).map(img => `
                                        <img src="${img}" alt="${product.name}" class="w-20 h-20 object-cover rounded cursor-pointer opacity-70 hover:opacity-100 transition-opacity">
                                    `).join('')}
                                </div>
                            ` : ''}
                        ` : `
                            <div class="w-full h-64 bg-gradient-to-br from-beige to-navy rounded-lg flex items-center justify-center">
                                <div class="text-6xl text-navy">üíé</div>
                            </div>
                        `}
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <span class="bg-beige text-navy px-3 py-1 rounded-full text-sm font-bold">
                                ${product.category}
                            </span>
                            ${product.source === 'caisy' ? `
                                <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm">
                                    ‚òÅÔ∏è Desde Caisy
                                </span>
                            ` : ''}
                        </div>
                        
                        <h2 class="text-3xl font-bold text-beige mb-4">${product.name}</h2>
                        
                        <p class="text-navy-light text-lg mb-6">
                            ${product.description || 'Producto de sublimaci√≥n personalizable de alta calidad.'}
                        </p>
                        
                        <div class="bg-beige bg-opacity-10 rounded-lg p-4 mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-beige font-medium">Precio:</span>
                                <span class="text-2xl font-bold text-beige">$${product.price.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-beige font-medium">Disponibilidad:</span>
                                <span class="text-navy-light">
                                    ${product.stock > 0 ? `${product.stock} en stock` : 'Agotado'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button class="w-full btn-primary text-navy py-3 rounded-lg font-bold text-lg" ${product.stock <= 0 ? 'disabled' : ''}>
                                ${product.stock > 0 ? 'üõí Solicitar Cotizaci√≥n' : '‚ùå Agotado'}
                            </button>
                            <button onclick="shareProduct('${product.id}')" class="w-full glass-effect py-3 rounded-lg font-medium hover:bg-beige hover:bg-opacity-20 transition-all">
                                üì§ Compartir Producto
                            </button>
                        </div>
                        
                        <div class="mt-6 text-sm text-navy-light">
                            <p>üíé Sublimaci√≥n de alta calidad</p>
                            <p>üé® Personalizaci√≥n disponible</p>
                            <p>üöö Env√≠o a todo el pa√≠s</p>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Close modal
        function closeModal() {
            document.getElementById('productModal').classList.remove('show');
        }

        // Share product
        function shareProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            if (navigator.share) {
                navigator.share({
                    title: product.name,
                    text: `Mira este producto de Panu Sublimaciones: ${product.name} - $${product.price.toFixed(2)}`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                const text = `${product.name} - $${product.price.toFixed(2)} | Panu Sublimaciones - ${window.location.href}`;
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Enlace copiado al portapapeles', 'success');
                });
            }
        }

        // Scroll to products
        function scrollToProducts() {
            document.querySelector('main').scrollIntoView({ behavior: 'smooth' });
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium max-w-sm ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Editor variables
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#000000';
        let currentSize = 5;
        let lastX = 0;
        let lastY = 0;

        // Initialize editor
        function initializeEditor() {
            canvas = document.getElementById('designCanvas');
            ctx = canvas.getContext('2d');
            
            // Set up canvas
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Canvas event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Tool event listeners
            document.getElementById('colorPicker').addEventListener('change', (e) => {
                currentColor = e.target.value;
            });
            
            document.getElementById('brushSize').addEventListener('input', (e) => {
                currentSize = e.target.value;
                document.getElementById('brushSizeValue').textContent = currentSize;
            });
            
            document.getElementById('fontSize').addEventListener('input', (e) => {
                document.getElementById('fontSizeValue').textContent = e.target.value;
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // Set initial background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // Open editor
        function openEditor() {
            document.getElementById('editorModal').classList.add('show');
            if (!canvas) {
                setTimeout(initializeEditor, 100);
            }
        }

        // Close editor
        function closeEditor() {
            document.getElementById('editorModal').classList.remove('show');
        }

        // Set drawing tool
        function setTool(tool) {
            currentTool = tool;
            
            // Update tool buttons
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-beige', 'bg-opacity-20', 'text-navy');
            });
            
            event.target.classList.add('active', 'bg-beige', 'bg-opacity-20', 'text-navy');
            
            // Show/hide text tools
            const textTools = document.getElementById('textTools');
            if (tool === 'text') {
                textTools.classList.remove('hidden');
            } else {
                textTools.classList.add('hidden');
            }
            
            // Change cursor
            canvas.style.cursor = tool === 'text' ? 'text' : 'crosshair';
        }

        // Start drawing
        function startDrawing(e) {
            if (currentTool === 'text') {
                addText(e);
                return;
            }
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        // Draw function
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }

        // Stop drawing
        function stopDrawing() {
            isDrawing = false;
        }

        // Handle touch events
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        // Add text to canvas
        function addText(e) {
            const text = document.getElementById('textInput').value;
            if (!text) {
                showNotification('Escribe un texto primero', 'warning');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const font = document.getElementById('fontSelect').value;
            const size = document.getElementById('fontSize').value;
            
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = currentColor;
            ctx.font = `${size}px ${font}`;
            ctx.fillText(text, x, y);
        }

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Scale image to fit canvas
                    const maxWidth = canvas.width * 0.5;
                    const maxHeight = canvas.height * 0.5;
                    
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    // Draw image at center
                    const x = (canvas.width - width) / 2;
                    const y = (canvas.height - height) / 2;
                    
                    ctx.drawImage(img, x, y, width, height);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Clear canvas
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            showNotification('Canvas limpiado', 'success');
        }

        // Download design
        function downloadDesign() {
            const link = document.createElement('a');
            link.download = 'mi-dise√±o-panu.png';
            link.href = canvas.toDataURL();
            link.click();
            showNotification('Dise√±o descargado', 'success');
        }

        // Save design
        function saveDesign() {
            const designData = canvas.toDataURL();
            const designs = JSON.parse(localStorage.getItem('panuDesigns') || '[]');
            
            const newDesign = {
                id: 'design_' + Date.now(),
                name: `Dise√±o ${designs.length + 1}`,
                data: designData,
                product: document.getElementById('productSelect').value,
                createdAt: new Date().toISOString()
            };
            
            designs.push(newDesign);
            localStorage.setItem('panuDesigns', JSON.stringify(designs));
            
            showNotification('Dise√±o guardado correctamente', 'success');
        }

        // Request quote
        function requestQuote() {
            const designData = canvas.toDataURL();
            const product = document.getElementById('productSelect').value;
            
            // Get customer info
            const customerName = document.getElementById('textInput').value || 'Cliente';
            
            // Create email content
            const subject = `Solicitud de Cotizaci√≥n - ${product} - ${customerName}`;
            const body = `Hola Panu Sublimaciones,

Me gustar√≠a solicitar una cotizaci√≥n para el siguiente producto personalizado:

Producto: ${product}
Cliente: ${customerName}
Fecha: ${new Date().toLocaleDateString()}

He adjuntado mi dise√±o personalizado. Por favor, env√≠enme informaci√≥n sobre:
- Precio del producto con mi dise√±o
- Tiempo de producci√≥n
- Opciones de env√≠o
- Cualquier recomendaci√≥n t√©cnica

Quedo atento a su respuesta.

Saludos cordiales.

---
Dise√±o creado con el Editor de Panu Sublimaciones
${window.location.href}`;

            // Create mailto link
            const mailtoLink = `mailto:panu@aurical.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Try to open email client
            try {
                window.open(mailtoLink, '_blank');
                showNotification('üìß Abriendo tu cliente de email para enviar la cotizaci√≥n a panu@aurical.org', 'success');
                
                // Also save the quote locally for backup
                const quotes = JSON.parse(localStorage.getItem('panuQuotes') || '[]');
                quotes.push({
                    id: 'quote_' + Date.now(),
                    design: designData,
                    product: product,
                    customerName: customerName,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                });
                localStorage.setItem('panuQuotes', JSON.stringify(quotes));
                
            } catch (error) {
                // Fallback: show contact info
                showNotification('Por favor contacta directamente a: panu@aurical.org', 'info');
                console.log('Quote data saved locally:', { designData, product, customerName });
            }
        }

        // Close modal on outside click
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        document.getElementById('editorModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditor();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f25612672a3472',t:'MTc2MDU2Mjk3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
