<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panu Design Editor - Editor de Dise√±os Personalizados</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(222, 184, 135, 0.3);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border-color: rgba(139, 69, 19, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8B4513, #A0522D, #CD853F);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #A0522D, #CD853F, #DEB887);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #8B4513;
            border: 2px solid #8B4513;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #8B4513;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.3);
        }
        
        .canvas-container {
            position: relative;
            background: #f8f9fa;
            border: 3px solid #ddd;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .design-canvas {
            position: relative;
            width: 100%;
            height: 420px;
            background: white;
            overflow: hidden;
            cursor: crosshair;
        }
        
        .product-template {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .design-area {
            position: absolute;
            border: 2px dashed #007bff;
            background: rgba(0, 123, 255, 0.1);
            z-index: 5;
        }
        
        .user-image {
            position: absolute;
            cursor: move;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            z-index: 15;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .user-image:hover {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }
        
        .user-image.selected {
            border-color: #007bff;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }
        
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nw-resize;
        }
        
        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }
        
        .resize-handle.sw {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize;
        }
        
        .resize-handle.ne {
            top: -6px;
            right: -6px;
            cursor: ne-resize;
        }
        
        .resize-handle.nw {
            top: -6px;
            left: -6px;
            cursor: nw-resize;
        }
        
        .product-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .product-option {
            background: white;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .product-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .product-option.active {
            border-color: #8B4513;
            background: rgba(139, 69, 19, 0.1);
            transform: translateY(-3px);
        }
        
        .product-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            display: block;
        }
        
        .tools-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 16px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .tool-group {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .tool-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .tool-label {
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8B4513;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8B4513;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .color-picker {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .preview-panel {
            background: white;
            border-radius: 15px;
            padding: 16px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-left: 4px solid;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left-color: #10b981;
        }
        
        .notification.error {
            border-left-color: #ef4444;
        }
        
        .notification.info {
            border-left-color: #3b82f6;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .design-canvas {
                height: 320px;
            }
            
            .product-selector {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .product-option {
                padding: 8px;
            }
            
            .product-icon {
                font-size: 1.6rem;
                margin-bottom: 3px;
            }
            
            /* Mobile layout optimization */
            .mobile-controls {
                position: sticky;
                top: 10px;
                z-index: 100;
                background: rgba(255, 255, 255, 0.98);
                border-radius: 15px;
                padding: 12px;
                margin: 10px 0;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(10px);
            }
            
            .mobile-controls .tool-group {
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            .mobile-controls .slider-container {
                margin: 6px 0;
            }
            
            .btn-primary, .btn-secondary {
                padding: 14px 20px;
                font-size: 0.9rem;
                touch-action: manipulation;
            }
            
            .resize-handle {
                width: 20px;
                height: 20px;
                border: 3px solid white;
                touch-action: none;
            }
            
            .resize-handle.se {
                bottom: -10px;
                right: -10px;
            }
            
            .resize-handle.sw {
                bottom: -10px;
                left: -10px;
            }
            
            .resize-handle.ne {
                top: -10px;
                right: -10px;
            }
            
            .resize-handle.nw {
                top: -10px;
                left: -10px;
            }
            
            .user-image {
                min-width: 60px;
                min-height: 60px;
            }
            
            .design-canvas {
                touch-action: none;
                -webkit-overflow-scrolling: touch;
            }
            
            .slider {
                height: 8px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
            .slider::-moz-range-thumb {
                width: 24px;
                height: 24px;
            }
            
            .notification {
                right: 10px;
                left: 10px;
                top: 10px;
                transform: translateY(-100px);
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
        
        @media (max-width: 480px) {
            .design-canvas {
                height: 300px;
            }
            
            .product-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body><!-- Header -->
  <header class="bg-gradient-to-r from-slate-800 via-slate-700 to-slate-600 text-white shadow-2xl">
   <div class="max-w-7xl mx-auto px-3 py-4">
    <div class="flex items-center justify-between">
     <div class="flex items-center space-x-4"><a href="panu.html" class="btn-primary text-sm px-4 py-2 flex items-center space-x-2 hover:scale-105 transition-transform no-underline"> <span>üè†</span> <span class="hidden sm:inline">Inicio</span> </a> <img src="https://aurical.org/images/PanuLogo.png" alt="Panu Logo" class="w-12 h-12 rounded-full bg-white p-2 shadow-lg" onerror="this.style.display='none';">
      <div>
       <h1 class="text-2xl md:text-3xl font-bold" id="editor-title">Panu Design Editor</h1>
       <p class="text-slate-200 text-sm md:text-base font-medium">Editor de Dise√±os Personalizados</p>
      </div>
     </div>
     <div class="text-right">
      <div class="text-xs text-slate-200" id="contact-info"><a href="https://wa.me/595985501874" target="_blank" rel="noopener noreferrer" class="hover:text-green-400 transition-colors">WhatsApp: +595985501874</a> | <a href="mailto:aurical@panu.org?subject=Consulta%20sobre%20Panu%20Design%20Editor" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors">aurical@panu.org</a>
      </div>
      <div class="text-xs text-slate-400">
       Contacto directo
      </div>
     </div>
    </div>
   </div>
  </header><!-- Main Content -->
  <main class="max-w-7xl mx-auto px-3 py-6"><!-- Product Selection -->
   <section class="glass-card p-4 mb-6 fade-in">
    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">üõçÔ∏è Selecciona tu Producto</h2>
    <div class="product-selector">
     <div class="product-option active" onclick="selectProduct('tshirt', this)"><span class="product-icon">üëï</span>
      <div class="font-semibold">
       Remera
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('mug', this)"><span class="product-icon">‚òï</span>
      <div class="font-semibold">
       Taza
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('hoppie', this)"><span class="product-icon">ü•§</span>
      <div class="font-semibold">
       Hoppie
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('notebook', this)"><span class="product-icon">üìì</span>
      <div class="font-semibold">
       Cuadernito
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('mousepad', this)"><span class="product-icon">üñ±Ô∏è</span>
      <div class="font-semibold">
       Mouse Pad
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('cap', this)"><span class="product-icon">üß¢</span>
      <div class="font-semibold">
       Gorra
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('backpack', this)"><span class="product-icon">üéí</span>
      <div class="font-semibold">
       Mochila
      </div>
     </div>
     <div class="product-option" onclick="selectProduct('lunchbox', this)"><span class="product-icon">üç±</span>
      <div class="font-semibold">
       Lonchera
      </div>
     </div>
    </div>
   </section><!-- Mobile Image Controls (shown only when image is selected) -->
   <div class="mobile-controls lg:hidden" id="mobile-image-controls" style="display: none;">
    <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">üéõÔ∏è Controles de Imagen</h3>
    <div class="tool-group">
     <div class="mb-3"><label class="block text-xs font-medium mb-1">Tama√±o</label>
      <div class="slider-container"><input type="range" id="mobile-size-slider" class="slider" min="10" max="200" value="100" oninput="updateImageSize(this.value)">
       <div class="flex justify-between text-xs text-gray-500 mt-1"><span>10%</span> <span id="mobile-size-value">100%</span> <span>200%</span>
       </div>
      </div>
     </div>
     <div class="mb-3"><label class="block text-xs font-medium mb-1">Rotaci√≥n</label>
      <div class="slider-container"><input type="range" id="mobile-rotation-slider" class="slider" min="0" max="360" value="0" oninput="updateImageRotation(this.value)">
       <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0¬∞</span> <span id="mobile-rotation-value">0¬∞</span> <span>360¬∞</span>
       </div>
      </div>
     </div>
     <div class="mb-3"><label class="block text-xs font-medium mb-1">Opacidad</label>
      <div class="slider-container"><input type="range" id="mobile-opacity-slider" class="slider" min="10" max="100" value="100" oninput="updateImageOpacity(this.value)">
       <div class="flex justify-between text-xs text-gray-500 mt-1"><span>10%</span> <span id="mobile-opacity-value">100%</span> <span>100%</span>
       </div>
      </div>
     </div>
     <div class="grid grid-cols-4 gap-2"><button onclick="flipImage('horizontal')" class="btn-secondary text-xs py-2"> ‚ÜîÔ∏è </button> <button onclick="flipImage('vertical')" class="btn-secondary text-xs py-2"> ‚ÜïÔ∏è </button> <button onclick="moveLayer('front')" class="btn-secondary text-xs py-2"> ‚¨ÜÔ∏è </button> <button onclick="deleteSelectedImage()" class="btn-secondary text-xs py-2 bg-red-500 text-white border-red-500"> üóëÔ∏è </button>
     </div>
    </div>
   </div><!-- Editor Layout -->
   <div class="grid grid-cols-1 lg:grid-cols-4 gap-6"><!-- Tools Panel (Desktop) -->
    <div class="lg:col-span-1 hidden lg:block">
     <div class="tools-panel fade-in">
      <h3 class="text-base font-bold text-gray-800 mb-3">Herramientas</h3><!-- Image Upload -->
      <div class="tool-group">
       <div class="tool-label">
        Subir Imagen
       </div><input type="file" id="image-upload" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)"> <button onclick="document.getElementById('image-upload').click()" class="btn-primary w-full mb-3"> Seleccionar Im√°genes </button> <button onclick="addTestImage()" class="btn-secondary w-full mb-3 text-sm"> Imagen de Prueba </button>
       <div class="text-xs text-gray-500">
        Formatos: JPG, PNG, GIF<br>
         Tama√±o m√°ximo: 5MB
       </div>
      </div><!-- Image Controls -->
      <div class="tool-group" id="image-controls" style="display: none;">
       <div class="tool-label">
        Controles de Imagen
       </div>
       <div class="mb-4"><label class="block text-sm font-medium mb-2">Tama√±o</label>
        <div class="slider-container"><input type="range" id="size-slider" class="slider" min="10" max="200" value="100" oninput="updateImageSize(this.value)">
         <div class="flex justify-between text-xs text-gray-500 mt-1"><span>10%</span> <span id="size-value">100%</span> <span>200%</span>
         </div>
        </div>
       </div>
       <div class="mb-4"><label class="block text-sm font-medium mb-2">Rotaci√≥n</label>
        <div class="slider-container"><input type="range" id="rotation-slider" class="slider" min="0" max="360" value="0" oninput="updateImageRotation(this.value)">
         <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0¬∞</span> <span id="rotation-value">0¬∞</span> <span>360¬∞</span>
         </div>
        </div>
       </div>
       <div class="mb-4"><label class="block text-sm font-medium mb-2">Opacidad</label>
        <div class="slider-container"><input type="range" id="opacity-slider" class="slider" min="10" max="100" value="100" oninput="updateImageOpacity(this.value)">
         <div class="flex justify-between text-xs text-gray-500 mt-1"><span>10%</span> <span id="opacity-value">100%</span> <span>100%</span>
         </div>
        </div>
       </div>
       <div class="grid grid-cols-2 gap-2 mb-4"><button onclick="flipImage('horizontal')" class="btn-secondary text-sm"> Voltear H </button> <button onclick="flipImage('vertical')" class="btn-secondary text-sm"> Voltear V </button>
       </div><button onclick="deleteSelectedImage()" class="btn-secondary w-full text-sm bg-red-500 text-white border-red-500 hover:bg-red-600"> Eliminar Imagen </button>
      </div><!-- Layer Controls -->
      <div class="tool-group">
       <div class="tool-label">
        Capas
       </div>
       <div class="grid grid-cols-2 gap-2"><button onclick="moveLayer('front')" class="btn-secondary text-sm"> Al Frente </button> <button onclick="moveLayer('back')" class="btn-secondary text-sm"> Atr√°s </button>
       </div>
      </div><!-- Actions -->
      <div class="tool-group">
       <div class="tool-label">
        Acciones
       </div><button onclick="clearCanvas()" class="btn-secondary w-full mb-2 text-sm"> Limpiar Todo </button> <button onclick="resetCanvas()" class="btn-secondary w-full mb-2 text-sm"> Reiniciar </button> <button onclick="downloadDesign()" class="btn-primary w-full text-sm"> üì• Descargar Dise√±o </button>
      </div>
     </div>
    </div><!-- Canvas Area -->
    <div class="lg:col-span-2">
     <div class="glass-card p-4 fade-in">
      <div class="flex items-center justify-between mb-4">
       <h3 class="text-base font-bold text-gray-800">√Årea de Dise√±o</h3>
       <div class="flex items-center space-x-2"><!-- Mobile Upload Button --> <button onclick="document.getElementById('image-upload-mobile').click()" class="btn-primary text-sm px-3 py-2 lg:hidden"> üì∑ Subir </button> <input type="file" id="image-upload-mobile" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)"> <button onclick="addTestImage()" class="btn-secondary text-sm px-3 py-2 lg:hidden"> üé® </button> <button onclick="zoomCanvas('in')" class="btn-secondary text-sm px-3 py-2"> + </button> <button onclick="zoomCanvas('out')" class="btn-secondary text-sm px-3 py-2"> - </button> <button onclick="zoomCanvas('fit')" class="btn-secondary text-sm px-3 py-2"> ‚öè </button>
       </div>
      </div>
      <div class="canvas-container">
       <div class="design-canvas" id="design-canvas"><!-- Product Template -->
        <svg class="product-template" id="product-template" viewbox="0 0 500 500"><!-- T-shirt template --> <g id="tshirt-template">
          <path d="M150 100 L150 80 Q150 70 160 70 L340 70 Q350 70 350 80 L350 100 L380 120 L380 180 L360 180 L360 450 Q360 460 350 460 L150 460 Q140 460 140 450 L140 180 L120 180 L120 120 Z" fill="#f8f9fa" stroke="#ddd" stroke-width="2" />
          <rect x="180" y="120" width="140" height="180" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area" id="design-area" />
         </g>
        </svg><!-- User images will be added here -->
       </div>
      </div>
      <div class="mt-4 text-center text-sm text-gray-600">
       <div class="mb-2"><strong>üíª PC:</strong> Arrastra y suelta im√°genes directamente en el √°rea de dise√±o
       </div>
       <div class="mb-3"><strong>üì± M√≥vil:</strong> Para mover im√°genes, desliza tu dedo <em>cerca</em> de la imagen (no directamente sobre ella)
       </div>
       <div class="text-xs text-gray-500 border-t pt-2"><strong>Panu Design Editor v1.069</strong><br>
         Built by <strong>Joel P√°ez</strong> and <strong>Ren_q (Alexa Ferreira)</strong>
       </div>
      </div>
     </div>
    </div><!-- Preview Panel -->
    <div class="lg:col-span-1">
     <div class="preview-panel fade-in">
      <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">üëÅÔ∏è Vista Previa</h3>
      <div class="mb-4">
       <div class="bg-gray-100 rounded-lg p-4 text-center">
        <div class="text-4xl mb-2" id="preview-icon">
         üëï
        </div>
        <div class="font-semibold" id="preview-name">
         Remera
        </div>
        <div class="text-sm text-gray-600" id="preview-description">
         Remera de algod√≥n 100%
        </div>
       </div>
      </div><!-- Design Info -->
      <div class="space-y-4">
       <div class="bg-blue-50 rounded-lg p-4">
        <h4 class="font-semibold text-blue-800 mb-2">üìä Informaci√≥n del Dise√±o</h4>
        <div class="text-sm space-y-1">
         <div>
          Producto: <span id="info-product">Remera</span>
         </div>
         <div>
          Im√°genes: <span id="info-images">0</span>
         </div>
         <div>
          Dimensiones: <span id="info-dimensions">500x500px</span>
         </div>
        </div>
       </div>
       <div class="bg-green-50 rounded-lg p-4">
        <h4 class="font-semibold text-green-800 mb-2">‚úÖ Estado del Dise√±o</h4>
        <div class="text-sm" id="design-status-info">
         Listo para enviar a nuestros dise√±adores
        </div>
       </div>
       <div class="space-y-3"><button onclick="sendToDesigners()" class="btn-primary w-full"> üì§ Enviar a Dise√±adores </button>
        <div class="text-center">
         <div class="text-xs text-gray-600 mb-2">
          Tipo de compra:
         </div>
         <div class="flex space-x-2"><button onclick="selectPurchaseType('individual')" id="btn-individual" class="btn-secondary text-xs px-3 py-1 flex-1 bg-blue-100 border-blue-300"> üë§ Individual </button> <button onclick="selectPurchaseType('empresa')" id="btn-empresa" class="btn-secondary text-xs px-3 py-1 flex-1"> üè¢ Empresa </button>
         </div>
        </div>
       </div><!-- Mobile Actions -->
       <div class="lg:hidden space-y-2"><button onclick="clearCanvas()" class="btn-secondary w-full text-sm"> üóëÔ∏è Limpiar Todo </button> <button onclick="downloadDesign()" class="btn-primary w-full text-sm"> üì• Descargar Dise√±o </button>
       </div>
       <div class="text-xs text-gray-500 text-center">
        Nuestros dise√±adores profesionales crear√°n una versi√≥n mejorada de tu dise√±o
       </div>
      </div>
     </div>
    </div>
   </div>
  </main><!-- Hidden canvas for export -->
  <canvas id="export-canvas" style="display: none;"></canvas>
  <script>
        // Global variables
        let currentProduct = 'tshirt';
        let selectedImage = null;
        let imageCounter = 0;
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let canvasZoom = 1;
        let images = [];
        let purchaseType = 'individual'; // 'individual' or 'empresa'

        // Configuration
        const defaultConfig = {
            editor_title: "Panu Design Editor",
            contact_info: "WhatsApp: +1234567890"
        };

        // Product templates
        const productTemplates = {
            tshirt: {
                name: 'Remera',
                icon: 'üëï',
                description: 'Remera de algod√≥n 100%',
                designArea: { x: 180, y: 120, width: 140, height: 180 },
                template: `<path d="M150 100 L150 80 Q150 70 160 70 L340 70 Q350 70 350 80 L350 100 L380 120 L380 180 L360 180 L360 450 Q360 460 350 460 L150 460 Q140 460 140 450 L140 180 L120 180 L120 120 Z" 
                          fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <rect x="180" y="120" width="140" height="180" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area" id="design-area"/>`
            },
            mug: {
                name: 'Taza',
                icon: '‚òï',
                description: 'Taza de cer√°mica 11oz',
                designArea: { x: 200, y: 150, width: 100, height: 120 },
                template: `<ellipse cx="250" cy="350" rx="80" ry="20" fill="#ddd"/>
                          <rect x="170" y="150" width="160" height="200" rx="10" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <path d="M330 200 Q350 200 350 220 L350 280 Q350 300 330 300" fill="none" stroke="#ddd" stroke-width="3"/>
                          <rect x="200" y="150" width="100" height="120" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            },
            hoppie: {
                name: 'Hoppie T√©rmico',
                icon: 'ü•§',
                description: 'Vaso t√©rmico tipo Stanley',
                designArea: { x: 210, y: 120, width: 80, height: 140 },
                template: `<ellipse cx="250" cy="380" rx="50" ry="15" fill="#ddd"/>
                          <rect x="200" y="100" width="100" height="280" rx="8" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <rect x="195" y="95" width="110" height="25" rx="12" fill="#333"/>
                          <circle cx="320" cy="150" r="8" fill="none" stroke="#ddd" stroke-width="2"/>
                          <path d="M320 142 L340 150 L320 158" fill="none" stroke="#ddd" stroke-width="2"/>
                          <rect x="210" y="120" width="80" height="140" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            },
            notebook: {
                name: 'Cuadernito',
                icon: 'üìì',
                description: 'Agenda personalizada A5',
                designArea: { x: 170, y: 100, width: 160, height: 220 },
                template: `<rect x="150" y="80" width="200" height="280" rx="8" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <rect x="150" y="80" width="200" height="40" fill="#8B4513"/>
                          <line x1="160" y1="140" x2="340" y2="140" stroke="#ddd" stroke-width="1"/>
                          <line x1="160" y1="160" x2="340" y2="160" stroke="#ddd" stroke-width="1"/>
                          <line x1="160" y1="180" x2="340" y2="180" stroke="#ddd" stroke-width="1"/>
                          <line x1="160" y1="200" x2="340" y2="200" stroke="#ddd" stroke-width="1"/>
                          <rect x="170" y="100" width="160" height="220" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            },
            mousepad: {
                name: 'Mouse Pad',
                icon: 'üñ±Ô∏è',
                description: 'Mouse pad rectangular',
                designArea: { x: 100, y: 150, width: 300, height: 200 },
                template: `<rect x="80" y="130" width="340" height="240" rx="20" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <rect x="100" y="150" width="300" height="200" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            },
            cap: {
                name: 'Gorra',
                icon: 'üß¢',
                description: 'Gorra ajustable',
                designArea: { x: 200, y: 180, width: 100, height: 80 },
                template: `<ellipse cx="250" cy="350" rx="120" ry="30" fill="#ddd"/>
                          <path d="M130 250 Q130 150 250 150 Q370 150 370 250 L370 300 Q370 320 350 320 L150 320 Q130 320 130 300 Z" 
                                fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <ellipse cx="250" cy="200" rx="80" ry="15" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>
                          <rect x="200" y="180" width="100" height="80" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            },
            backpack: {
                name: 'Mochila',
                icon: 'üéí',
                description: 'Mochila escolar/deportiva',
                designArea: { x: 190, y: 140, width: 120, height: 160 },
                template: `<ellipse cx="250" cy="420" rx="70" ry="20" fill="#ddd"/>
                          <rect x="180" y="120" width="140" height="280" rx="15" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <rect x="170" y="110" width="160" height="30" rx="15" fill="#8B4513"/>
                          <rect x="200" y="90" width="100" height="40" rx="8" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <circle cx="200" cy="150" r="3" fill="#333"/>
                          <circle cx="300" cy="150" r="3" fill="#333"/>
                          <path d="M220 100 Q250 85 280 100" fill="none" stroke="#8B4513" stroke-width="4"/>
                          <rect x="190" y="140" width="120" height="160" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            },
            lunchbox: {
                name: 'Lonchera',
                icon: 'üç±',
                description: 'Lonchera t√©rmica',
                designArea: { x: 170, y: 180, width: 160, height: 100 },
                template: `<ellipse cx="250" cy="350" rx="90" ry="15" fill="#ddd"/>
                          <rect x="150" y="160" width="200" height="120" rx="12" fill="#f8f9fa" stroke="#ddd" stroke-width="2"/>
                          <rect x="145" y="155" width="210" height="20" rx="10" fill="#8B4513"/>
                          <circle cx="180" cy="165" r="4" fill="#CD853F"/>
                          <circle cx="320" cy="165" r="4" fill="#CD853F"/>
                          <path d="M200 165 Q250 150 300 165" fill="none" stroke="#CD853F" stroke-width="3"/>
                          <rect x="160" y="190" width="40" height="60" rx="5" fill="none" stroke="#ddd" stroke-width="1"/>
                          <rect x="210" y="190" width="80" height="60" rx="5" fill="none" stroke="#ddd" stroke-width="1"/>
                          <rect x="300" y="190" width="40" height="60" rx="5" fill="none" stroke="#ddd" stroke-width="1"/>
                          <rect x="170" y="180" width="160" height="100" fill="none" stroke="#007bff" stroke-width="2" stroke-dasharray="5,5" class="design-area"/>`
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            setupEventListeners();
        });

        // Initialize editor
        function initializeEditor() {
            updateProductTemplate();
            updatePreview();
            
            // Initialize Element SDK
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    render: async (config) => {
                        document.getElementById('editor-title').textContent = config.editor_title || defaultConfig.editor_title;
                        document.getElementById('contact-info').textContent = config.contact_info || defaultConfig.contact_info;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["editor_title", config.editor_title || defaultConfig.editor_title],
                        ["contact_info", config.contact_info || defaultConfig.contact_info]
                    ])
                });
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const canvas = document.getElementById('design-canvas');
            
            // Drag and drop
            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('drop', handleDrop);
            
            // Mouse events
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);
        }

        // Product selection
        function selectProduct(productType, element) {
            currentProduct = productType;
            
            // Update active state
            document.querySelectorAll('.product-option').forEach(option => {
                option.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update template and preview
            updateProductTemplate();
            updatePreview();
            updateCurrentProduct();
            
            showNotification(`Producto seleccionado: ${productTemplates[productType].name}`, 'success');
        }

        // Update product template
        function updateProductTemplate() {
            const template = productTemplates[currentProduct];
            const templateElement = document.getElementById('product-template');
            
            templateElement.innerHTML = template.template;
        }

        // Update preview
        function updatePreview() {
            const template = productTemplates[currentProduct];
            
            document.getElementById('preview-icon').textContent = template.icon;
            document.getElementById('preview-name').textContent = template.name;
            document.getElementById('preview-description').textContent = template.description;
            document.getElementById('info-product').textContent = template.name;
            document.getElementById('info-images').textContent = images.length;
        }

        // Update current product display
        function updateCurrentProduct() {
            const template = productTemplates[currentProduct];
            document.getElementById('current-product').textContent = template.name;
        }

        // Handle image upload
        function handleImageUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Imagen muy grande. M√°ximo 5MB.', 'error');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToCanvas(e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    showNotification('Formato no v√°lido. Use JPG, PNG o GIF.', 'error');
                }
            }
        }

        // Add image to canvas
        function addImageToCanvas(imageSrc) {
            const canvas = document.getElementById('design-canvas');
            const template = productTemplates[currentProduct];
            const designArea = template.designArea;
            
            const img = document.createElement('img');
            img.className = 'user-image';
            img.draggable = false;
            img.style.position = 'absolute';
            img.style.cursor = 'move';
            img.style.border = '2px solid transparent';
            img.style.transition = 'all 0.2s ease';
            img.style.zIndex = '50';
            img.style.userSelect = 'none';
            img.style.webkitUserSelect = 'none';
            img.style.webkitTouchCallout = 'none';
            
            // Add data attributes first
            img.dataset.id = 'img_' + (++imageCounter);
            img.dataset.rotation = '0';
            img.dataset.flipH = 'false';
            img.dataset.flipV = 'false';
            
            img.onload = function() {
                console.log('Image loaded successfully:', img.dataset.id);
                
                // Calculate initial size and position
                const maxWidth = designArea.width * 0.7;
                const maxHeight = designArea.height * 0.7;
                
                let width = this.naturalWidth || 200; // Fallback size
                let height = this.naturalHeight || 200; // Fallback size
                
                console.log('Original dimensions:', width, 'x', height);
                
                // Scale to fit design area
                if (width > maxWidth || height > maxHeight) {
                    const scaleX = maxWidth / width;
                    const scaleY = maxHeight / height;
                    const scale = Math.min(scaleX, scaleY);
                    
                    width *= scale;
                    height *= scale;
                }
                
                // Ensure minimum size for mobile
                const minSize = 60;
                if (width < minSize) {
                    const scale = minSize / width;
                    width *= scale;
                    height *= scale;
                }
                
                // Store original dimensions
                img.dataset.originalWidth = width;
                img.dataset.originalHeight = height;
                
                // Wait for canvas to be fully rendered
                setTimeout(() => {
                    // Get fresh canvas dimensions
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    // Calculate scale factor between SVG viewBox (500x500) and actual rendered size
                    const scaleFactorX = canvasRect.width / 500;
                    const scaleFactorY = canvasRect.height / 500;
                    
                    // Apply scale to design area coordinates
                    const actualDesignX = designArea.x * scaleFactorX;
                    const actualDesignY = designArea.y * scaleFactorY;
                    const actualDesignWidth = designArea.width * scaleFactorX;
                    const actualDesignHeight = designArea.height * scaleFactorY;
                    
                    // Center perfectly in the actual scaled design area
                    const x = actualDesignX + (actualDesignWidth - width) / 2;
                    const y = actualDesignY + (actualDesignHeight - height) / 2;
                    
                    img.style.left = Math.round(x) + 'px';
                    img.style.top = Math.round(y) + 'px';
                    img.style.width = Math.round(width) + 'px';
                    img.style.height = Math.round(height) + 'px';
                    img.style.transform = 'rotate(0deg)';
                    img.style.opacity = '1';
                    img.style.display = 'block';
                    
                    console.log('Image positioned at:', x, y, 'with size:', width, height);
                    
                    // Add to canvas and arrays
                    canvas.appendChild(img);
                    addResizeHandles(img);
                    
                    images.push(img);
                    selectImage(img);
                    updateStats();
                    
                    showNotification('‚úÖ Imagen agregada al dise√±o', 'success');
                }, 100); // Increased delay for better reliability
            };
            
            img.onerror = function() {
                console.error('Error loading image:', imageSrc);
                showNotification('‚ùå Error al cargar la imagen. Verifica el formato.', 'error');
            };
            
            // Add touch and click handlers before setting src
            img.addEventListener('click', function(e) {
                e.stopPropagation();
                selectImage(this);
            });
            
            img.addEventListener('touchstart', function(e) {
                e.stopPropagation();
                selectImage(this);
            });
            
            // Set src last to trigger loading
            img.src = imageSrc;
            console.log('Loading image:', img.dataset.id);
        }

        // Add resize handles to image
        function addResizeHandles(img) {
            const handles = ['nw', 'ne', 'sw', 'se'];
            
            handles.forEach(position => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${position}`;
                handle.dataset.position = position;
                
                handle.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    startResize(e, img, position);
                });
                
                img.appendChild(handle);
            });
        }

        // Select image
        function selectImage(img) {
            // Deselect all images
            document.querySelectorAll('.user-image').forEach(image => {
                image.classList.remove('selected');
                image.querySelectorAll('.resize-handle').forEach(handle => {
                    handle.style.display = 'none';
                });
            });
            
            // Select this image
            img.classList.add('selected');
            img.querySelectorAll('.resize-handle').forEach(handle => {
                handle.style.display = 'block';
            });
            
            selectedImage = img;
            showImageControls();
            updateImageControls();
            
            // Haptic feedback for mobile
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // Show image controls
        function showImageControls() {
            // Desktop controls
            const desktopControls = document.getElementById('image-controls');
            if (desktopControls) {
                desktopControls.style.display = 'block';
            }
            
            // Mobile controls
            const mobileControls = document.getElementById('mobile-image-controls');
            if (mobileControls) {
                mobileControls.style.display = 'block';
            }
        }

        // Update image controls
        function updateImageControls() {
            if (!selectedImage) return;
            
            const rect = selectedImage.getBoundingClientRect();
            const originalWidth = parseFloat(selectedImage.dataset.originalWidth);
            const currentWidth = parseFloat(selectedImage.style.width);
            const scale = Math.round((currentWidth / originalWidth) * 100);
            
            // Update desktop controls
            const sizeSlider = document.getElementById('size-slider');
            const sizeValue = document.getElementById('size-value');
            if (sizeSlider && sizeValue) {
                sizeSlider.value = scale;
                sizeValue.textContent = scale + '%';
            }
            
            // Update mobile controls
            const mobileSizeSlider = document.getElementById('mobile-size-slider');
            const mobileSizeValue = document.getElementById('mobile-size-value');
            if (mobileSizeSlider && mobileSizeValue) {
                mobileSizeSlider.value = scale;
                mobileSizeValue.textContent = scale + '%';
            }
            
            const rotation = selectedImage.dataset.rotation || '0';
            
            // Desktop rotation
            const rotationSlider = document.getElementById('rotation-slider');
            const rotationValue = document.getElementById('rotation-value');
            if (rotationSlider && rotationValue) {
                rotationSlider.value = rotation;
                rotationValue.textContent = rotation + '¬∞';
            }
            
            // Mobile rotation
            const mobileRotationSlider = document.getElementById('mobile-rotation-slider');
            const mobileRotationValue = document.getElementById('mobile-rotation-value');
            if (mobileRotationSlider && mobileRotationValue) {
                mobileRotationSlider.value = rotation;
                mobileRotationValue.textContent = rotation + '¬∞';
            }
            
            const opacity = Math.round(parseFloat(selectedImage.style.opacity || 1) * 100);
            
            // Desktop opacity
            const opacitySlider = document.getElementById('opacity-slider');
            const opacityValue = document.getElementById('opacity-value');
            if (opacitySlider && opacityValue) {
                opacitySlider.value = opacity;
                opacityValue.textContent = opacity + '%';
            }
            
            // Mobile opacity
            const mobileOpacitySlider = document.getElementById('mobile-opacity-slider');
            const mobileOpacityValue = document.getElementById('mobile-opacity-value');
            if (mobileOpacitySlider && mobileOpacityValue) {
                mobileOpacitySlider.value = opacity;
                mobileOpacityValue.textContent = opacity + '%';
            }
        }

        // Update image size
        function updateImageSize(value) {
            if (!selectedImage) return;
            
            const originalWidth = parseFloat(selectedImage.dataset.originalWidth);
            const originalHeight = parseFloat(selectedImage.dataset.originalHeight);
            
            const scale = value / 100;
            const newWidth = originalWidth * scale;
            const newHeight = originalHeight * scale;
            
            selectedImage.style.width = newWidth + 'px';
            selectedImage.style.height = newHeight + 'px';
            
            // Update both desktop and mobile displays
            const sizeValue = document.getElementById('size-value');
            const mobileSizeValue = document.getElementById('mobile-size-value');
            if (sizeValue) sizeValue.textContent = value + '%';
            if (mobileSizeValue) mobileSizeValue.textContent = value + '%';
            
            // Sync sliders
            const sizeSlider = document.getElementById('size-slider');
            const mobileSizeSlider = document.getElementById('mobile-size-slider');
            if (sizeSlider) sizeSlider.value = value;
            if (mobileSizeSlider) mobileSizeSlider.value = value;
        }

        // Update image rotation
        function updateImageRotation(value) {
            if (!selectedImage) return;
            
            selectedImage.style.transform = `rotate(${value}deg)`;
            selectedImage.dataset.rotation = value;
            
            // Update both desktop and mobile displays
            const rotationValue = document.getElementById('rotation-value');
            const mobileRotationValue = document.getElementById('mobile-rotation-value');
            if (rotationValue) rotationValue.textContent = value + '¬∞';
            if (mobileRotationValue) mobileRotationValue.textContent = value + '¬∞';
            
            // Sync sliders
            const rotationSlider = document.getElementById('rotation-slider');
            const mobileRotationSlider = document.getElementById('mobile-rotation-slider');
            if (rotationSlider) rotationSlider.value = value;
            if (mobileRotationSlider) mobileRotationSlider.value = value;
        }

        // Update image opacity
        function updateImageOpacity(value) {
            if (!selectedImage) return;
            
            selectedImage.style.opacity = value / 100;
            
            // Update both desktop and mobile displays
            const opacityValue = document.getElementById('opacity-value');
            const mobileOpacityValue = document.getElementById('mobile-opacity-value');
            if (opacityValue) opacityValue.textContent = value + '%';
            if (mobileOpacityValue) mobileOpacityValue.textContent = value + '%';
            
            // Sync sliders
            const opacitySlider = document.getElementById('opacity-slider');
            const mobileOpacitySlider = document.getElementById('mobile-opacity-slider');
            if (opacitySlider) opacitySlider.value = value;
            if (mobileOpacitySlider) mobileOpacitySlider.value = value;
        }

        // Flip image
        function flipImage(direction) {
            if (!selectedImage) return;
            
            let scaleX = selectedImage.dataset.flipH === 'true' ? -1 : 1;
            let scaleY = selectedImage.dataset.flipV === 'true' ? -1 : 1;
            
            if (direction === 'horizontal') {
                scaleX *= -1;
                selectedImage.dataset.flipH = scaleX === -1 ? 'true' : 'false';
            } else {
                scaleY *= -1;
                selectedImage.dataset.flipV = scaleY === -1 ? 'true' : 'false';
            }
            
            const rotation = selectedImage.dataset.rotation || '0';
            selectedImage.style.transform = `rotate(${rotation}deg) scaleX(${scaleX}) scaleY(${scaleY})`;
        }

        // Delete selected image
        function deleteSelectedImage() {
            if (!selectedImage) {
                showNotification('Selecciona una imagen primero', 'error');
                return;
            }
            
            selectedImage.remove();
            images = images.filter(img => img !== selectedImage);
            selectedImage = null;
            
            // Hide controls
            const desktopControls = document.getElementById('image-controls');
            const mobileControls = document.getElementById('mobile-image-controls');
            if (desktopControls) desktopControls.style.display = 'none';
            if (mobileControls) mobileControls.style.display = 'none';
            
            updateStats();
            
            showNotification('Imagen eliminada', 'success');
        }

        // Move layer
        function moveLayer(direction) {
            if (!selectedImage) {
                showNotification('Selecciona una imagen primero', 'error');
                return;
            }
            
            if (direction === 'front') {
                selectedImage.style.zIndex = '60';
            } else {
                selectedImage.style.zIndex = '40';
            }
            
            showNotification(`Imagen movida al ${direction === 'front' ? 'frente' : 'fondo'}`, 'success');
        }

        // Clear canvas
        function clearCanvas() {
            // Create inline confirmation
            const confirmOverlay = document.createElement('div');
            confirmOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            confirmOverlay.innerHTML = `
                <div class="glass-card p-6 max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">üóëÔ∏è Limpiar Todo</h3>
                    <p class="text-gray-600 mb-6">¬øEst√°s seguro de que quieres eliminar todas las im√°genes del dise√±o?</p>
                    <div class="flex space-x-4">
                        <button onclick="this.closest('.bg-black').remove()" class="btn-secondary flex-1">
                            ‚ùå Cancelar
                        </button>
                        <button onclick="confirmClearCanvas(this)" class="btn-primary flex-1 bg-red-500 hover:bg-red-600">
                            üóëÔ∏è Limpiar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmOverlay);
        }

        function confirmClearCanvas(buttonElement) {
            buttonElement.closest('.bg-black').remove();
            
            document.querySelectorAll('.user-image').forEach(img => img.remove());
            images = [];
            selectedImage = null;
            
            // Hide controls
            const desktopControls = document.getElementById('image-controls');
            const mobileControls = document.getElementById('mobile-image-controls');
            if (desktopControls) desktopControls.style.display = 'none';
            if (mobileControls) mobileControls.style.display = 'none';
            
            updateStats();
            
            showNotification('Dise√±o limpiado', 'success');
        }

        // Reset canvas
        function resetCanvas() {
            clearCanvas();
            canvasZoom = 1;
            updateProductTemplate();
        }

        // Zoom canvas
        function zoomCanvas(action) {
            const canvas = document.getElementById('design-canvas');
            
            if (action === 'in') {
                canvasZoom = Math.min(canvasZoom * 1.2, 3);
            } else if (action === 'out') {
                canvasZoom = Math.max(canvasZoom / 1.2, 0.5);
            } else if (action === 'fit') {
                canvasZoom = 1;
            }
            
            canvas.style.transform = `scale(${canvasZoom})`;
            canvas.style.transformOrigin = 'center center';
        }

        // Generate design with watermark for download
        function generateDesignWithWatermark(callback) {
            const canvas = document.getElementById('export-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 800;
            canvas.height = 800;
            
            // Draw clean white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Scale design area to fit canvas (centered)
            const template = productTemplates[currentProduct];
            const scale = 1.4;
            const offsetX = (canvas.width - 500 * scale) / 2;
            const offsetY = (canvas.height - 500 * scale) / 2;
            
            // Draw product template shape (actual product silhouette)
            drawProductTemplate(ctx, template, scale, offsetX, offsetY);
            
            // Draw user images
            let loadedImages = 0;
            const totalImages = images.length;
            
            if (totalImages === 0) {
                addCreditsAndFinish();
                return;
            }
            
            images.forEach(img => {
                const newImg = new Image();
                newImg.crossOrigin = 'anonymous';
                newImg.onload = function() {
                    // Get the current canvas dimensions for proper scaling
                    const canvasElement = document.getElementById('design-canvas');
                    const canvasRect = canvasElement.getBoundingClientRect();
                    
                    // Calculate the scale factor between the actual canvas size and SVG viewBox (500x500)
                    const canvasScaleX = canvasRect.width / 500;
                    const canvasScaleY = canvasRect.height / 500;
                    
                    // Convert image position from screen coordinates to SVG coordinates
                    const imgLeft = parseFloat(img.style.left);
                    const imgTop = parseFloat(img.style.top);
                    const imgWidth = parseFloat(img.style.width);
                    const imgHeight = parseFloat(img.style.height);
                    
                    // Convert to SVG coordinate system first
                    const svgX = imgLeft / canvasScaleX;
                    const svgY = imgTop / canvasScaleY;
                    const svgWidth = imgWidth / canvasScaleX;
                    const svgHeight = imgHeight / canvasScaleY;
                    
                    // Now apply export canvas scaling
                    const x = svgX * scale + offsetX;
                    const y = svgY * scale + offsetY;
                    const width = svgWidth * scale;
                    const height = svgHeight * scale;
                    
                    const rotation = parseFloat(img.dataset.rotation || 0);
                    const opacity = parseFloat(img.style.opacity || 1);
                    
                    ctx.save();
                    ctx.globalAlpha = opacity;
                    ctx.translate(x + width/2, y + height/2);
                    ctx.rotate(rotation * Math.PI / 180);
                    
                    // Handle flips
                    const flipH = img.dataset.flipH === 'true' ? -1 : 1;
                    const flipV = img.dataset.flipV === 'true' ? -1 : 1;
                    ctx.scale(flipH, flipV);
                    
                    ctx.drawImage(this, -width/2, -height/2, width, height);
                    ctx.restore();
                    
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        addCreditsAndFinish();
                    }
                };
                newImg.onerror = function() {
                    console.error('Error loading image for export');
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        addCreditsAndFinish();
                    }
                };
                newImg.src = img.src;
            });
            
            function addCreditsAndFinish() {
                // Add small credits in bottom right corner
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('Panu Design Editor', canvas.width - 15, canvas.height - 15);
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.95);
                callback(dataURL);
            }
        }
        
        // Draw product template on canvas
        function drawProductTemplate(ctx, template, scale, offsetX, offsetY) {
            ctx.save();
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);
            
            // Set common styles
            ctx.fillStyle = '#f8f9fa';
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            
            // Draw based on product type
            switch (currentProduct) {
                case 'tshirt':
                    // T-shirt shape
                    ctx.beginPath();
                    ctx.moveTo(150, 100);
                    ctx.lineTo(150, 80);
                    ctx.quadraticCurveTo(150, 70, 160, 70);
                    ctx.lineTo(340, 70);
                    ctx.quadraticCurveTo(350, 70, 350, 80);
                    ctx.lineTo(350, 100);
                    ctx.lineTo(380, 120);
                    ctx.lineTo(380, 180);
                    ctx.lineTo(360, 180);
                    ctx.lineTo(360, 450);
                    ctx.quadraticCurveTo(360, 460, 350, 460);
                    ctx.lineTo(150, 460);
                    ctx.quadraticCurveTo(140, 460, 140, 450);
                    ctx.lineTo(140, 180);
                    ctx.lineTo(120, 180);
                    ctx.lineTo(120, 120);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                    
                case 'mug':
                    // Mug base shadow
                    ctx.fillStyle = '#ddd';
                    ctx.beginPath();
                    ctx.ellipse(250, 350, 80, 20, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Mug body
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(170, 150, 160, 200);
                    ctx.strokeRect(170, 150, 160, 200);
                    
                    // Mug handle
                    ctx.beginPath();
                    ctx.moveTo(330, 200);
                    ctx.quadraticCurveTo(350, 200, 350, 220);
                    ctx.lineTo(350, 280);
                    ctx.quadraticCurveTo(350, 300, 330, 300);
                    ctx.stroke();
                    break;
                    
                case 'hoppie':
                    // Hoppie base shadow
                    ctx.fillStyle = '#ddd';
                    ctx.beginPath();
                    ctx.ellipse(250, 380, 50, 15, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Hoppie body
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(200, 100, 100, 280);
                    ctx.strokeRect(200, 100, 100, 280);
                    
                    // Hoppie lid
                    ctx.fillStyle = '#333';
                    ctx.fillRect(195, 95, 110, 25);
                    
                    // Straw hole
                    ctx.strokeStyle = '#ddd';
                    ctx.beginPath();
                    ctx.arc(320, 150, 8, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                    
                case 'notebook':
                    // Notebook cover
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(150, 80, 200, 280);
                    ctx.strokeRect(150, 80, 200, 280);
                    
                    // Notebook binding
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(150, 80, 200, 40);
                    
                    // Lines
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                    for (let i = 140; i <= 200; i += 20) {
                        ctx.beginPath();
                        ctx.moveTo(160, i);
                        ctx.lineTo(340, i);
                        ctx.stroke();
                    }
                    break;
                    
                case 'mousepad':
                    // Mousepad
                    ctx.fillStyle = '#f8f9fa';
                    ctx.beginPath();
                    ctx.roundRect(80, 130, 340, 240, 20);
                    ctx.fill();
                    ctx.stroke();
                    break;
                    
                case 'cap':
                    // Cap base shadow
                    ctx.fillStyle = '#ddd';
                    ctx.beginPath();
                    ctx.ellipse(250, 350, 120, 30, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Cap body
                    ctx.fillStyle = '#f8f9fa';
                    ctx.beginPath();
                    ctx.moveTo(130, 250);
                    ctx.quadraticCurveTo(130, 150, 250, 150);
                    ctx.quadraticCurveTo(370, 150, 370, 250);
                    ctx.lineTo(370, 300);
                    ctx.quadraticCurveTo(370, 320, 350, 320);
                    ctx.lineTo(150, 320);
                    ctx.quadraticCurveTo(130, 320, 130, 300);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                    
                case 'backpack':
                    // Backpack base shadow
                    ctx.fillStyle = '#ddd';
                    ctx.beginPath();
                    ctx.ellipse(250, 420, 70, 20, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Backpack body
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(180, 120, 140, 280);
                    ctx.strokeRect(180, 120, 140, 280);
                    
                    // Top flap
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(170, 110, 160, 30);
                    
                    // Front pocket
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(200, 90, 100, 40);
                    ctx.strokeRect(200, 90, 100, 40);
                    
                    // Buckles
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(200, 150, 3, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(300, 150, 3, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Handle
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(220, 100);
                    ctx.quadraticCurveTo(250, 85, 280, 100);
                    ctx.stroke();
                    break;
                    
                case 'lunchbox':
                    // Lunchbox base shadow
                    ctx.fillStyle = '#ddd';
                    ctx.beginPath();
                    ctx.ellipse(250, 350, 90, 15, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Lunchbox body
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(150, 160, 200, 120);
                    ctx.strokeRect(150, 160, 200, 120);
                    
                    // Lid
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(145, 155, 210, 20);
                    
                    // Latches
                    ctx.fillStyle = '#CD853F';
                    ctx.beginPath();
                    ctx.arc(180, 165, 4, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(320, 165, 4, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Handle
                    ctx.strokeStyle = '#CD853F';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(200, 165);
                    ctx.quadraticCurveTo(250, 150, 300, 165);
                    ctx.stroke();
                    
                    // Compartments
                    ctx.strokeStyle = '#ddd';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(160, 190, 40, 60);
                    ctx.strokeRect(210, 190, 80, 60);
                    ctx.strokeRect(300, 190, 40, 60);
                    break;
            }
            
            ctx.restore();
        }

        // Download design preview (manual download)
        function downloadDesign() {
            if (images.length === 0) {
                showNotification('Agrega al menos una imagen antes de descargar', 'error');
                return;
            }
            
            showNotification('üì• Generando dise√±o...', 'info');
            
            generateDesignWithWatermark((dataURL) => {
                const link = document.createElement('a');
                link.download = `panu-design-${currentProduct}-${Date.now()}.jpg`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('‚úÖ Dise√±o descargado correctamente', 'success');
            });
        }

        // Select purchase type
        function selectPurchaseType(type) {
            purchaseType = type;
            
            // Update button styles
            document.getElementById('btn-individual').className = 'btn-secondary text-xs px-3 py-1 flex-1';
            document.getElementById('btn-empresa').className = 'btn-secondary text-xs px-3 py-1 flex-1';
            
            if (type === 'individual') {
                document.getElementById('btn-individual').className += ' bg-blue-100 border-blue-300';
            } else {
                document.getElementById('btn-empresa').className += ' bg-blue-100 border-blue-300';
            }
        }

        // Send to designers
        function sendToDesigners() {
            if (images.length === 0) {
                showNotification('Agrega al menos una imagen antes de enviar', 'error');
                return;
            }
            
            if (purchaseType === 'individual') {
                sendToWhatsApp();
            } else {
                showContactOptions();
            }
        }

        // Send to WhatsApp (for individual purchases)
        function sendToWhatsApp() {
            showNotification('üì• Descargando dise√±o autom√°ticamente...', 'info');
            
            // First download the design
            generateDesignWithWatermark((dataURL) => {
                const link = document.createElement('a');
                link.download = `panu-design-${currentProduct}-${Date.now()}.jpg`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Then open WhatsApp after a short delay
                setTimeout(() => {
                    const designInfo = `
üé® *Nuevo Dise√±o - AURICAL ART DESIGN*

üì¶ *Producto:* ${productTemplates[currentProduct].name}
üñºÔ∏è *Im√°genes:* ${images.length}
üìÖ *Fecha:* ${new Date().toLocaleDateString()}
üíº *Tipo:* Compra Individual

¬°Hola! He creado un dise√±o personalizado usando su editor y me gustar√≠a que sus dise√±adores profesionales lo mejoren.

üìé *El dise√±o se descarg√≥ autom√°ticamente en mi dispositivo*

¬øPodr√≠an ayudarme con una cotizaci√≥n para este producto personalizado?

¬°Gracias!
                    `.trim();
                    
                    const whatsappUrl = `https://wa.me/595985501874?text=${encodeURIComponent(designInfo)}`;
                    window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    
                    showSuccessMessage('WhatsApp', 'individual');
                }, 1000);
            });
        }

        // Show contact options (for empresa purchases)
        function showContactOptions() {
            const optionsOverlay = document.createElement('div');
            optionsOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            optionsOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-lg mx-4 text-center">
                    <div class="text-4xl mb-4">üè¢</div>
                    <h3 class="text-2xl font-bold mb-4">Compra Empresarial</h3>
                    <p class="text-gray-600 mb-6">Elige c√≥mo prefieres contactarnos para tu cotizaci√≥n empresarial:</p>
                    
                    <div class="space-y-4 mb-6">
                        <button onclick="sendEmpresaWhatsApp(); this.closest('.bg-black').remove();" class="btn-primary w-full flex items-center justify-center space-x-2">
                            <span>üí¨</span>
                            <span>WhatsApp Empresarial</span>
                        </button>
                        
                        <button onclick="sendEmpresaEmail(); this.closest('.bg-black').remove();" class="btn-secondary w-full flex items-center justify-center space-x-2">
                            <span>üìß</span>
                            <span>Correo Electr√≥nico</span>
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.bg-black').remove()" class="text-gray-500 hover:text-gray-700 text-sm">
                        ‚ùå Cancelar
                    </button>
                </div>
            `;
            document.body.appendChild(optionsOverlay);
        }

        // Send empresa WhatsApp
        function sendEmpresaWhatsApp() {
            showNotification('üì• Descargando dise√±o autom√°ticamente...', 'info');
            
            // First download the design
            generateDesignWithWatermark((dataURL) => {
                const link = document.createElement('a');
                link.download = `panu-design-empresa-${currentProduct}-${Date.now()}.jpg`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Then open WhatsApp after a short delay
                setTimeout(() => {
                    const designInfo = `
üè¢ *Cotizaci√≥n Empresarial - AURICAL ART DESIGN*

üì¶ *Producto:* ${productTemplates[currentProduct].name}
üñºÔ∏è *Im√°genes:* ${images.length}
üìÖ *Fecha:* ${new Date().toLocaleDateString()}
üíº *Tipo:* Compra Empresarial

¬°Hola! Represento a una empresa y estamos interesados en un dise√±o personalizado. He creado un boceto inicial usando su editor y nos gustar√≠a:

‚Ä¢ Cotizaci√≥n para producci√≥n empresarial
‚Ä¢ Mejoras profesionales del dise√±o
‚Ä¢ Opciones de cantidad y precios
‚Ä¢ Tiempos de entrega

üìé *El dise√±o se descarg√≥ autom√°ticamente en mi dispositivo*

¬øPodr√≠an contactarnos para discutir los detalles del proyecto?

¬°Gracias!
                    `.trim();
                    
                    const whatsappUrl = `https://wa.me/595985501874?text=${encodeURIComponent(designInfo)}`;
                    window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    
                    showSuccessMessage('WhatsApp', 'empresa');
                }, 1000);
            });
        }

        // Send empresa email
        function sendEmpresaEmail() {
            const subject = `Cotizaci√≥n Empresarial - Dise√±o ${productTemplates[currentProduct].name}`;
            const body = `
Estimado equipo de Panu Design,

Represento a una empresa y estamos interesados en solicitar una cotizaci√≥n para producci√≥n empresarial.

DETALLES DEL DISE√ëO:
‚Ä¢ Producto: ${productTemplates[currentProduct].name}
‚Ä¢ N√∫mero de im√°genes: ${images.length}
‚Ä¢ Fecha de solicitud: ${new Date().toLocaleDateString()}
‚Ä¢ Tipo: Compra Empresarial

SOLICITUD:
Hemos creado un dise√±o inicial usando su editor y nos gustar√≠a:

1. Cotizaci√≥n para diferentes cantidades de producci√≥n
2. Mejoras profesionales del dise√±o por parte de sus dise√±adores
3. Opciones de personalizaci√≥n adicionales
4. Tiempos de entrega estimados
5. Condiciones comerciales para empresas

Por favor, cont√°ctennos para coordinar una reuni√≥n y discutir los detalles del proyecto.

Quedamos atentos a su respuesta.

Saludos cordiales.

---
Generado desde Panu Design Editor
${new Date().toLocaleString()}
            `.trim();
            
            const mailtoUrl = `mailto:aurical@panu.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoUrl, '_blank', 'noopener,noreferrer');
            
            showSuccessMessage('Email', 'empresa');
        }

        // Show success message
        function showSuccessMessage(contactMethod, type) {
            const typeText = type === 'individual' ? 'Individual' : 'Empresarial';
            const icon = contactMethod === 'WhatsApp' ? 'üí¨' : 'üìß';
            
            const successOverlay = document.createElement('div');
            successOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            successOverlay.innerHTML = `
                <div class="glass-card p-8 max-w-lg mx-4 text-center">
                    <div class="text-6xl mb-4">${icon}</div>
                    <h3 class="text-2xl font-bold mb-4">¬°Mensaje Enviado!</h3>
                    <p class="text-gray-600 mb-4">Tu mensaje ${typeText.toLowerCase()} ha sido enviado por ${contactMethod}.</p>
                    
                    <div class="bg-orange-50 rounded-lg p-4 mb-6 border-l-4 border-orange-400">
                        <div class="font-semibold text-orange-800 mb-2">üìé Siguiente Paso:</div>
                        <div class="text-sm text-orange-700">
                            <strong>Env√≠a tu dise√±o desde la galer√≠a</strong><br>
                            El dise√±o se descarg√≥ autom√°ticamente en tu dispositivo.<br>
                            Comp√°rtelo por WhatsApp para completar tu solicitud.
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="font-semibold text-blue-800">Detalles del env√≠o:</div>
                        <div class="text-sm text-blue-600 mt-2">
                            Producto: ${productTemplates[currentProduct].name}<br>
                            Im√°genes: ${images.length}<br>
                            Tipo: Compra ${typeText}<br>
                            M√©todo: ${contactMethod}<br>
                            Fecha: ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="downloadDesign(); this.closest('.bg-black').remove();" class="btn-secondary flex-1">
                            üì• Descargar Dise√±o
                        </button>
                        <button onclick="this.closest('.bg-black').remove()" class="btn-primary flex-1">
                            ‚úÖ Entendido
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(successOverlay);
        }

        // Mouse event handlers
        function handleMouseDown(e) {
            const target = e.target;
            
            if (target.classList.contains('user-image')) {
                selectImage(target);
                startDrag(e, target);
            } else if (target.classList.contains('resize-handle')) {
                // Handled by resize handle event listener
            } else {
                // Deselect all images
                document.querySelectorAll('.user-image').forEach(img => {
                    img.classList.remove('selected');
                    img.querySelectorAll('.resize-handle').forEach(handle => {
                        handle.style.display = 'none';
                    });
                });
                selectedImage = null;
                
                // Hide controls
                const desktopControls = document.getElementById('image-controls');
                const mobileControls = document.getElementById('mobile-image-controls');
                if (desktopControls) desktopControls.style.display = 'none';
                if (mobileControls) mobileControls.style.display = 'none';
            }
        }

        function handleMouseMove(e) {
            if (isDragging && selectedImage) {
                const rect = document.getElementById('design-canvas').getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                selectedImage.style.left = x + 'px';
                selectedImage.style.top = y + 'px';
            }
        }

        function handleMouseUp(e) {
            isDragging = false;
            isResizing = false;
        }

        // Touch event handlers
        function handleTouchStart(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            const canvasRect = document.getElementById('design-canvas').getBoundingClientRect();
            const touchX = touch.clientX - canvasRect.left;
            const touchY = touch.clientY - canvasRect.top;
            
            // Find the topmost image at touch point with generous padding
            const images = Array.from(document.querySelectorAll('.user-image')).reverse(); // Check from top to bottom
            let touchedImage = null;
            
            for (let img of images) {
                const imgRect = {
                    left: parseFloat(img.style.left) || 0,
                    top: parseFloat(img.style.top) || 0,
                    width: parseFloat(img.style.width) || img.offsetWidth,
                    height: parseFloat(img.style.height) || img.offsetHeight
                };
                
                // Generous touch area - 20px padding on all sides
                const padding = 20;
                if (touchX >= imgRect.left - padding && 
                    touchX <= imgRect.left + imgRect.width + padding && 
                    touchY >= imgRect.top - padding && 
                    touchY <= imgRect.top + imgRect.height + padding) {
                    touchedImage = img;
                    break;
                }
            }
            
            if (touchedImage) {
                selectImage(touchedImage);
                startDrag({ clientX: touch.clientX, clientY: touch.clientY }, touchedImage);
                
                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } else {
                // Deselect all images
                document.querySelectorAll('.user-image').forEach(img => {
                    img.classList.remove('selected');
                    img.querySelectorAll('.resize-handle').forEach(handle => {
                        handle.style.display = 'none';
                    });
                });
                selectedImage = null;
                
                // Hide controls
                const desktopControls = document.getElementById('image-controls');
                const mobileControls = document.getElementById('mobile-image-controls');
                if (desktopControls) desktopControls.style.display = 'none';
                if (mobileControls) mobileControls.style.display = 'none';
            }
        }

        function handleTouchMove(e) {
            if (isDragging && selectedImage) {
                e.preventDefault();
                e.stopPropagation();
                
                const touch = e.touches[0];
                const rect = document.getElementById('design-canvas').getBoundingClientRect();
                const x = touch.clientX - rect.left - dragOffset.x;
                const y = touch.clientY - rect.top - dragOffset.y;
                
                // Direct update for better responsiveness
                selectedImage.style.left = x + 'px';
                selectedImage.style.top = y + 'px';
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            e.stopPropagation();
            isDragging = false;
            isResizing = false;
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDrop(e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToCanvas(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Start drag
        function startDrag(e, img) {
            isDragging = true;
            const rect = img.getBoundingClientRect();
            const canvasRect = document.getElementById('design-canvas').getBoundingClientRect();
            
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
        }

        // Start resize
        function startResize(e, img, position) {
            e.preventDefault();
            isResizing = true;
            selectedImage = img;
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = parseFloat(img.style.width);
            const startHeight = parseFloat(img.style.height);
            const startLeft = parseFloat(img.style.left);
            const startTop = parseFloat(img.style.top);
            
            function resize(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                const aspectRatio = startWidth / startHeight;
                
                if (position.includes('e')) {
                    newWidth = Math.max(20, startWidth + deltaX);
                    newHeight = newWidth / aspectRatio;
                }
                if (position.includes('w')) {
                    newWidth = Math.max(20, startWidth - deltaX);
                    newHeight = newWidth / aspectRatio;
                    newLeft = startLeft + (startWidth - newWidth);
                }
                if (position.includes('s')) {
                    newHeight = Math.max(20, startHeight + deltaY);
                    newWidth = newHeight * aspectRatio;
                }
                if (position.includes('n')) {
                    newHeight = Math.max(20, startHeight - deltaY);
                    newWidth = newHeight * aspectRatio;
                    newTop = startTop + (startHeight - newHeight);
                }
                
                img.style.width = newWidth + 'px';
                img.style.height = newHeight + 'px';
                img.style.left = newLeft + 'px';
                img.style.top = newTop + 'px';
                
                updateImageControls();
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        }

        // Update stats
        function updateStats() {
            document.getElementById('info-images').textContent = images.length;
            updatePreview();
        }

        // Add test image
        function addTestImage() {
            try {
                console.log('Creating test image...');
                
                // Create a simple test image using canvas
                const testCanvas = document.createElement('canvas');
                testCanvas.width = 300;
                testCanvas.height = 300;
                const ctx = testCanvas.getContext('2d');
                
                // Create gradient background
                const gradient = ctx.createLinearGradient(0, 0, 300, 300);
                gradient.addColorStop(0, '#8B4513');
                gradient.addColorStop(0.5, '#CD853F');
                gradient.addColorStop(1, '#DEB887');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 300, 300);
                
                // Add decorative border
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 8;
                ctx.strokeRect(20, 20, 260, 260);
                
                // Add inner border
                ctx.lineWidth = 3;
                ctx.strokeRect(40, 40, 220, 220);
                
                // Add text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('PANU', 150, 120);
                
                ctx.font = 'bold 20px Arial';
                ctx.fillText('Dise√±o', 150, 160);
                ctx.fillText('Personalizado', 150, 185);
                
                // Add version info
                ctx.font = '12px Arial';
                ctx.fillText('v1.069', 150, 220);
                
                // Add decorative elements
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.arc(80, 80, 15, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(220, 80, 15, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(80, 220, 15, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(220, 220, 15, 0, 2 * Math.PI);
                ctx.fill();
                
                // Convert to data URL with high quality
                const dataURL = testCanvas.toDataURL('image/png', 1.0);
                console.log('Test image created, data URL length:', dataURL.length);
                
                // Add to canvas
                addImageToCanvas(dataURL);
                
                showNotification('üé® Imagen de prueba agregada', 'success');
                
            } catch (error) {
                console.error('Error creating test image:', error);
                showNotification('‚ùå Error al crear imagen de prueba', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <p class="font-medium">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700 ml-4">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }
            }, 5000);
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9920fc63a4c500e0',t:'MTc2MTA1MjEzMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>